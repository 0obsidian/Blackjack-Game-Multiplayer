<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackjack21.io</title>
  <!-- <link rel="stylesheet" href="/css/lib/normalize.css"> -->
  <link rel="stylesheet" href="/css/dist/style.css">
  <link rel="stylesheet" href="/css/style.scss">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div id="loading-screen" class="hide-element">
    <img id="loading-icon" src="/imgs/Loadingicon.png" alt="Loading...">    
  </div>

  <div id="info-rules">
    <div id="how-to-play">
      HOW TO PLAY
    </div>
    <div id="info-rules-overflow">
    <div>
      <h1 id="h1margin">OBJECT OF THE GAME</h1>
      <P>
        Each participant attempts to beat the dealer by getting a count as close to 21 as possible, without going above 21.
      </P>
    </div>
    <div>
      <h1>CARD VALUES/SCORING</h1>
      <p>
        Usually it's up to each individual player if an ace is worth 1 or 11. However in this game if a player stands with an ace, it will always count the ace as 11 if your total sum doesn't exceed 21. Face cards are 10 and any other card is its original value.</p>
    </div>
    <div>
      <h1>BETTING</h1>
      <p>
        Before the dealer begins dealing out cards, each player must place a bet and hit ready.</p>
    </div>
    <div>
      <h1>THE DEAL</h1>
      <p>
        The round starts with the dealer giving out 2 cards to each player. He also gives himself one card facing up & one card facing down.</p>
    </div>
    <div>
      <h1>NATURALS</h1>
      <p>
        When the intial 2 cards has been dealt: If a player gets a count to 21 on the first 2 cards, the player gets whats called Blackjack. Blakjack pays out 3:2 directly to the player and he will wait until next round to play again.</p>
    </div>
    <div>
      <h1>THE PLAY</h1>
      <p>
        Now its time for the first player to make his move.
        The player can Hit, Stand, Or Double Down.
        <ul>
          <li><strong>Hit</strong> = ask for another card in attempt to get closer to 21.</li>
          <li><strong>Stand</strong> = Don't ask for any cards, moves on to the next player</li>
          <li><strong>Double Down</strong> = Double the bet and ask for another card. (Can only double down once per round & can't draw any more cards after double'd down).</li>
        </ul>
      </p>
    </div>
    <div>
      <h1>THE DEALER'S PLAY</h1>
      <p>
        Dealer starts with taking his card facing down. Dealer will draw until he reaches 17, when dealer's sum is 17 or above, he stops taking cards.
      </p>
    </div>
    <div>
      <h1>PAYOUT</h1>
      <p>
        <ul>
          <li>If the player busts, he will lose his bet, even if the dealer also busts.</li>
          <li>If player has higher value cards than the dealer, the player wins.</li>
          <li>If dealer has higher value cards than the player, the dealer wins.</li>
        </ul>
      </p>
    </div>
  </div>
  </div>

  <div id="main-menu" class="">
    <img id="blackjack-title" src="/imgs/blackjack21io.png" alt="blackjack21.io">
    <div id="main-box">
      <div id="avatar-box">
        <button class="prev" onclick="plusSlides(-1)">
          <i class="fas fa-chevron-left"></i>          
        </button>
        <span class="slideAvatars" data-value="user">
          <div class="numbertext">1 / 8</div>
          <img src="/imgs/avatars/user.svg" alt="avatar">
        </span>
        <span class="slideAvatars" data-value="mafia" style="display: none;">
          <div class="numbertext">2 / 8</div>
          <img src="/imgs/avatars/mafia.svg" alt="avatar">
        </span>
        <span class="slideAvatars" data-value="casino" style="display: none;">
          <div class="numbertext">3 / 8</div>
          <img src="/imgs/avatars/casino.svg" alt="avatar">
        </span> 
        <span class="slideAvatars" data-value="baby" style="display: none;">
          <div class="numbertext">4 / 8</div>
          <img src="/imgs/avatars/baby.svg" alt="avatar">
        </span> 
        <span class="slideAvatars" data-value="terrorist" style="display: none;">
          <div class="numbertext">5 / 8</div>
          <img src="/imgs/avatars/terrorist.svg" alt="avatar">
        </span> 
        <span class="slideAvatars" data-value="detective" style="display: none;">
          <div class="numbertext">6 / 8</div>
          <img src="/imgs/avatars/detective.svg" alt="avatar">
        </span> 
        <span class="slideAvatars" data-value="work-out" style="display: none;">
          <div class="numbertext">7 / 8</div>
          <img src="/imgs/avatars/work-out.svg" alt="avatar">
        </span> 
        <span class="slideAvatars" data-value="manager" style="display: none;">
          <div class="numbertext">8 / 8</div>
          <img src="/imgs/avatars/manager.svg" alt="avatar">
        </span>
        <button class="next" onclick="plusSlides(1)">
          <i class="fas fa-chevron-right"></i>
        </button>

      </div>
      <div>
        <input id="nickname" type="text" placeholder="Nickname" maxlength="12">
      </div>
      <div>
        <button id="btnOffline" class="play-btns noclick-nohide"><span><i class="fas fa-user"></i></span>Play Offline</button>
      </div>
      <div>
        <button id="btnCreate" class="play-btns noclick-nohide"><span><i class="fas fa-users"></i></span>Create Room</button>
      </div>
      <div>
        <button id="btnJoin" class="play-btns noclick-nohide hide-element"><span><i class="fas fa-users"></i></span>Join Room</button>
      </div>
    </div>
    <div id="about-box">
      <strong>blackjack21.io</strong> is a free multiplayer casino game.
      <ul>
        <strong>NOTE:</strong>
        <li>Every game uses ONE standard 52-card pack that shuffles every round.</li>
        <li>Current version of the game does not support Splitting Cards & Insurance.</li>
        <li>2 aces on the first two cards gives you blackjack (21).</li>
        <li>A private room can consist up to 7 players.</li>
      </ul>
      <button id="about">
        About
      </button>
    </div>
  </div>

  <div id="game-room" class="hide-element">

  <!-- <div id="leave-box"> -->
    <!-- <i class="fas fa-sign-out-alt"></i> -->
    <button id="leave-button" onclick="exitRoom()">
      <i class="fas fa-sign-out-alt"></i>
      EXIT ROOM
    </button>
  <!-- </div> -->
  <button id="leave-table" class="noclick">
    <i class="far fa-arrow-alt-circle-left"></i>
    LEAVE TABLE
  </button>

  <div id="invite-link-box">
    <div id="invite-label">Hover to see invite link</div>
    <input id="invite-link" type="text">
    <button>COPY</button>
  </div>

  <div id="player-result-big" class="hide-element">
    <div id="player-result-big-answer"></div>
    <div id="player-result-sum-box">
      <span id="player-result-big-plus-minus"></span>
      <span id="player-result-big-sum"></span>
    </div>
  </div>

  <div id="deal-start-label" class="hide-element">
    <p>Waiting for bets <span id="seconds">39</span><span>.</span><span id="milliseconds">9</span></p>
    <!-- </span><span>.</span><span id="milliseconds"></span> -->
  </div>

  <div id="join-mid-game-label" class="hide-element">
    Game currently ongoing...
  </div>

  <div id="users-online-box">
    <div>
      <h4>Users in room</h4>
    </div>
    <ul id="users-online-container">
      <!-- <li class="users-list-box">
        <div class="users-list-info">
          <div class="user-list-name">Name</div>
          <div>Balance: <span class="users-list-balance">1000</span></div>
        </div>
        <div class="users-list-img">
          <img src="/imgs/avatars/user.svg" alt="avatar">
        </div>
      </li> -->
    </ul>
  </div>



  <div id="dealer">
    <h1>Dealer</h1>
    <div id="dealerSum">sum here</div>
    <div class="dealer-cards">
      <div class="visibleCards">
        <!-- <img class="dealerCardImg" src="/imgs/Diamond7.svg">
        <img class="dealerCardImg" src="/imgs/Diamond7.svg">
        <div class="flip-card">
          <div class="flip-card-inner">
            <div class="flip-card-front">
              <img class="dealerCardImg card-front" src="/imgs/Card_back.svg">
            </div>
            <div class="flip-card-back">
              <img class="dealerCardImg card-back" src="/imgs/Diamond7.svg">
            </div>
          </div>
        </div> -->

        <!-- <img class="dealerCardImg" src="/imgs/Diamond7.svg"> -->
        <!-- <img class="dealerCardImg hiddenCard" src="/imgs/Diamond7.svg"> -->
      </div>
      <!-- <div class="hiddenCard">
        <img src="/imgs/Card_back.svg" alt="">
      </div> -->
    </div>
  </div>
  <div class="user-action-container hide-element">
    <div id="your-turn-label">MAKE A DECISION</div>
    <div class="user-action-box">
      <button class="user-action" id="stand"><i class="fas fa-hand-paper"></i></button>
      <div class="user-action-text">STAND</div>
    </div>
    <div class="user-action-box">
      <button class="user-action" id="hit"><i class="fas fa-hand-pointer"></i></button>
      <div class="user-action-text">HIT</div>
    </div>
    <div class="user-action-box">
      <button class="user-action" id="doubleDown"><i class="fas fa-hand-peace"></i><span>2X</span></button>
      <div class="user-action-text">DOUBLE DOWN</div>
    </div>
  </div>
  <div id="players-container">
    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">name here<span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-coin hide-element">bet here<div class="player-bet hide-element"></div></div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
    </span>

    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">name here<span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-coin hide-element">bet here<div class="player-bet hide-element"></div></div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
    </span>

    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">name here<span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-coin hide-element">bet here<div class="player-bet hide-element"></div></div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
    </span>

    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">name here<span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-coin hide-element">bet here<div class="player-bet hide-element"></div></div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
    </span>

    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">name here<span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-coin hide-element">bet here<div class="player-bet hide-element"></div></div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
    </span>

    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">name here<span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-coin hide-element">bet here<div class="player-bet hide-element"></div></div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
    </span>

    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">name here<span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-coin hide-element">bet here<div class="player-bet hide-element"></div></div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
    </span>
  </div>

  <div id="players-timer-container">
    <svg class="players-timer">
      <circle class="" cx="50" cy="50" r="48" stroke-width="4" fill="transparent"/>
    </svg>
    <svg class="players-timer">
      <circle class="" cx="50" cy="50" r="48" stroke-width="4" fill="transparent"/>
    </svg>
    <svg class="players-timer">
      <circle class="" cx="50" cy="50" r="48" stroke-width="4" fill="transparent"/>
    </svg>
    <svg class="players-timer">
      <circle class="" cx="50" cy="50" r="48" stroke-width="4" fill="transparent"/>
    </svg>
    <svg class="players-timer">
      <circle class="" cx="50" cy="50" r="48" stroke-width="4" fill="transparent"/>
    </svg>
    <svg class="players-timer">
      <circle class="" cx="50" cy="50" r="48" stroke-width="4" fill="transparent"/>
    </svg>
    <svg class="players-timer">
      <circle class="" cx="50" cy="50" r="48" stroke-width="4" fill="transparent"/>
    </svg>
  </div>

  <div id="bets-container" class="noclick">
    <span>
      <button class="max-clear update-balance-bet">CLEAR</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip10" value="10">10</button>
      <!-- <img src="/imgs/chips/Casino_Chip_White2.svg" alt="">    -->
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip50" value="50">50</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip100" value="100">100</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip500" value="500">500</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip1k" value="1000">1K</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip5k" value="5000">5K</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip10k" value="10000">10K</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip50k" value="50000">50K</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip100k" value="100000">100K</button>
    </span>
    <span>
      <button class="max-clear update-balance-bet">MAX</button>
    </span>


  </div>
  <!-- <div id="dealer">
    <h2>Dealer</h2>
    <div id="dealerSum">sum here</div>
    <div class="dealer-cards">
      <div class="visibleCards">

      </div>
 
    </div>
  </div> -->
  <div id="balance-bet-box">
    <div class="balance-bet">
      Balance
      <div id="balance"></div>
    </div>
    <div class="balance-bet">
      Total Bet
      <div id="total-bet"></div>
    </div>
  </div>


</div>

<!-- PRE-LOAD DECK IMAGES -->
<div class="hidden">
	<script>
			var images = new Array()
			function preload() {
				for (i = 0; i < preload.arguments.length; i++) {
					images[i] = new Image()
					images[i].src = preload.arguments[i]
				}
			}
			preload(
        "/imgs/Heart2.svg",
        "/imgs/Heart3.svg",
        "/imgs/Heart4.svg",
        "/imgs/Heart5.svg",
        "/imgs/Heart6.svg",
        "/imgs/Heart7.svg",
        "/imgs/Heart8.svg",
        "/imgs/Heart9.svg",
        "/imgs/Heart10.svg",
        "/imgs/HeartJ.svg",
        "/imgs/HeartQ.svg",
        "/imgs/HeartK.svg",
        "/imgs/HeartA.svg",
        "/imgs/Diamond2.svg",
        "/imgs/Diamond3.svg",
        "/imgs/Diamond4.svg",
        "/imgs/Diamond5.svg",
        "/imgs/Diamond6.svg",
        "/imgs/Diamond7.svg",
        "/imgs/Diamond8.svg",
        "/imgs/Diamond9.svg",
        "/imgs/Diamond10.svg",
        "/imgs/DiamondJ.svg",
        "/imgs/DiamondQ.svg",
        "/imgs/DiamondK.svg",
        "/imgs/DiamondA.svg",
        "/imgs/Spade2.svg",
        "/imgs/Spade3.svg",
        "/imgs/Spade4.svg",
        "/imgs/Spade5.svg",
        "/imgs/Spade6.svg",
        "/imgs/Spade7.svg",
        "/imgs/Spade8.svg",
        "/imgs/Spade9.svg",
        "/imgs/Spade10.svg",
        "/imgs/SpadeJ.svg",
        "/imgs/SpadeQ.svg",
        "/imgs/SpadeK.svg",
        "/imgs/SpadeA.svg",
        "/imgs/Club2.svg",
        "/imgs/Club3.svg",
        "/imgs/Club4.svg",
        "/imgs/Club5.svg",
        "/imgs/Club6.svg",
        "/imgs/Club7.svg",
        "/imgs/Club8.svg",
        "/imgs/Club9.svg",
        "/imgs/Club10.svg",
        "/imgs/ClubJ.svg",
        "/imgs/ClubQ.svg",
        "/imgs/ClubK.svg",
        "/imgs/ClubA.svg"
			)
	</script>
</div>


  <script type="text/javascript" src="js/lib/jquery-3.5.1.min.js"></script>
  <script type="text/javascript" src="/js/app.js"></script>

  <script>
    if(window.location.href.length === 22) {
      $("#btnJoin").removeClass("noclick-nohide")
      $("#btnCreate").removeClass("noclick-nohide")
      $("#btnOffline").removeClass("noclick-nohide")
    }

    // HTML elements
    let clientId = null;
    let gameId = null;
    let roomId = null;
    let theClient = null;
    let storedPlayers = [];
    let fixCurrentPlayerLength = 0;
    players = [];
    spectators = [];
    // lobbySpectators = [];
    playerSlotHTML = [];

    let clicked = null;
    let doubleDown = null;
    let reload = null;
    let cardIndex = null;
    let cardIndexJoin = 0;
    let playerNaturalIndex = null;
    let dealersHiddenCard = "";
    let timerStarted = false;
    let newPlayer = null;

    let ws = new WebSocket("ws://localhost:8080")
    const btnCreate = document.getElementById("btnCreate");
    const btnJoin = document.getElementById("btnJoin");
    const txtGameId = document.getElementById("txtGameId");
    const divPlayers = document.getElementById("divPlayers");
    const divBoard = document.getElementById("divBoard");

    // CSS
    let nickname = document.querySelector("#nickname");
    let avatar = document.querySelectorAll(".slideAvatars")
    let playersLength = null;
    let theSlot = null;
    let z = null; // last player table index
    let aPlayer = null;
    let joined = false;
    let playerSlot = document.querySelectorAll(".players")
    let playerCards = document.querySelectorAll(".player-cards")
    let dealerCards = document.querySelectorAll(".dealer-cards")
    let dealerSlot = document.querySelector("#dealer")
    let playerName = document.querySelectorAll(".player-name")
    // let dealerHiddenCard = null;
    // let dealerHiddenCardRemoveNext = false;
    let resetCards = false;

    const leaveTable = document.querySelector("#leave-table")
    // CSS

    // wiring events
    window.addEventListener('load', function () {
    setTimeout(function(){ //wait 500ms before you can click a button, to prevent error
      $("#btnJoin").removeClass("noclick-nohide")
      $("#btnCreate").removeClass("noclick-nohide")
      $("#btnOffline").removeClass("noclick-nohide")
    // ***
    btnJoin.addEventListener("click", (e) => {
      $("#loading-screen").removeClass("hide-element")
      const payLoadLength = {
        "method": "playersLength",
        "gameId": gameId
      }
        ws.send(JSON.stringify(payLoadLength));      
      // Set 50ms delay so above method response before below function starts
      setTimeout(function() {

        if(playersLength >= 7) {
        $("#loading-screen").addClass("hide-element")
        alert("Game Is full!")
        return;
      } else {
        playerJoin()
        setTimeout(function() {
          $("#loading-screen").addClass("hide-element")
          $("#main-menu").addClass("hide-element")
          $("#game-room").removeClass("hide-element")
          }, 250)
        }
      }, 50)
    });

    btnCreate.addEventListener("click", (e) => {
      $("#loading-screen").removeClass("hide-element")
      const payLoad = {
        "method": "create",
        "clientId": clientId,
        "theClient": theClient,
        "playerSlot": playerSlot,
        "playerSlotHTML": playerSlotHTML,
        "roomId": roomId
      }
      ws.send(JSON.stringify(payLoad));

      // setTimeout(playerJoin, 500)
      setTimeout(function() {
      playerJoin()
      $("#loading-screen").addClass("hide-element")
      $("#main-menu").addClass("hide-element")
      $("#game-room").removeClass("hide-element")
      }, 300)
    });
    // ***
    }, 200)
    })


    leaveTable.addEventListener("click", (e) => {
      joined = false;
      theClient.balance = theClient.balance + theClient.bet;
      theClient.bet = 0;
      $("#total-bet").text(theClient.bet)
      $("#balance").text(theClient.balance)
      $("#bets-container").addClass("noclick");
      $("#leave-table").addClass("noclick");
      $(".empty-slot").removeClass("noclick");

      // Check if all players are ready that is on the table now
      if(players.length > 1) {
        let playersMinusOne = players;
        // Remove player from a clone of players array
        playersMinusOne.splice(players.findIndex(players => players.clientId === clientId), 1)
        for(let i = 0; i < playersMinusOne.length; i++) {
          if(playersMinusOne.every(playersMinuesOne => playersMinuesOne.isReady === true)) {
            $(".empty-slot").addClass("noclick");
          } else {
            $(".empty-slot").removeClass("noclick");
          }        
        }
      }

      terminatePlayer();
    });





    function playerJoin() {
      nickname = nickname.value
      theClient.nickname = nickname.value

      avatar = avatar[slideIndex-1].dataset.value
      theClient.avatar = avatar
      // if (gameId === null) {
      //   gameId = txtGameId.value;
      // }
      const payLoad = {
        "method": "join",
        "clientId": clientId,
        "gameId": gameId,
        "roomId": roomId,
        "theClient": theClient,
        "playerSlot": playerSlot,
        "playerSlotHTML": playerSlotHTML, 
        "players": players,
        "spectators": spectators,
        "nickname": nickname,
        "avatar": avatar
      }
      ws.send(JSON.stringify(payLoad));
    }




    function sendPlayerBets() {
      const payLoad = {
        "method": "bet",
        "players": players,
        "spectators": spectators
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updatePlayerCards() {
      const payLoad = {
        "method": "updatePlayerCards",
        "players": players,
        "spectators": spectators,
        "player": player,
        "resetCards": resetCards
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateDealerCards() {
      const payLoad = {
        "method": "updateDealerCards",
        "players": players,
        "spectators": spectators,
        "player": player,
        "dealer": dealer,
        "dealersTurn": dealersTurn,
        // "dealerHiddenCardRemoveNext": dealerHiddenCardRemoveNext
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendPlayerDeck() {
      const payLoad = {
        "method": "deck",
        "players": players,
        "spectators": spectators,
        "deck": deck,
        "clientDeal": clientDeal,
        "gameOn": gameOn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function clientIsReady() {

      const payLoad = {
        "method": "isReady",
        "players": players,
        "spectators": spectators,
        "theClient": theClient
      }
      ws.send(JSON.stringify(payLoad));
    }

    function clientHasLeft() {

      const payLoad = {
        "method": "hasLeft",
        "players": players,
        "spectators": spectators,
        "theClient": theClient
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updatePlayers() {
      const payLoad = {
        "method": "update",
        "players": players,
        "spectators": spectators,
        "dealer": dealer,
        "deck": deck,
        "gameOn": gameOn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateCurrentPlayer() {
      const payLoad = {
        "method": "currentPlayer",
        "players": players,
        "spectators": spectators,
        "player": player,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendPlayerThePlay() {
      console.log(player)
      const payLoad = {
        "method": "thePlay",
        "players": players,
        "spectators": spectators,
        "player": player,
        "currentPlayer": currentPlayer,
        "theClient": theClient,
        "dealersTurn": dealersTurn,
        "gameId": gameId
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendShowSum() {
      const payLoad = {
        "method": "showSum",
        "players": players,
        "spectators": spectators
      }
      ws.send(JSON.stringify(payLoad));
    }

    function joinTable() {
      const payLoad = {
        "method": "joinTable",
        "players": players,
        "spectators": spectators,
        "theClient": theClient,
        "theSlot": theSlot,
        "playerSlotHTML": playerSlotHTML,
        "gameId": gameId
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateTable() {
      const payLoad = {
        "method": "updateTable",
        "players": players,
        "spectators": spectators,
        "theClient": theClient,
        "theSlot": theSlot,
        "playerSlot": playerSlot,
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendDealersTurn() {
      const payLoad = {
        "method": "dealersTurn",
        "players": players,
        "spectators": spectators,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function terminatePlayer() {
      console.log("terminate")
      const payLoad = {
        "method": "terminate",
        "spectators": spectators,
        // "lobbySpectators": lobbySpectators,
        "theClient": theClient,
        "gameId": gameId,
        "playerSlotHTML": playerSlotHTML,
        "players": players,
        "reload": reload,
        "clientDeal": clientDeal,
        "playersCanPlay": playersCanPlay,
        "player": player,
        "gameOn": gameOn
      }
      ws.send(JSON.stringify(payLoad));

    }

    function resetRound() {
      const payLoad = {
        "method": "resetRound",
        "spectators": spectators,
        "theClient": theClient
      }
      ws.send(JSON.stringify(payLoad));
    }

    function playerResult() {
      const payLoad = {
        "method": "playerResult",
        "spectators": spectators,
        "players": players
      }
      ws.send(JSON.stringify(payLoad));
    }

    function playerResultNatural() {
      const payLoad = {
        "method": "playerResultNatural",
        "spectators": spectators,
        "players": players,
        "playerNaturalIndex": playerNaturalIndex
      }
      ws.send(JSON.stringify(payLoad));
    }

    function finalCompare() {
      const payLoad = {
        "method": "finalCompare",
        "gameId": gameId,
        "spectators": spectators,
        "players": players,
      }
      ws.send(JSON.stringify(payLoad));
    }

    function resetGameState() {
      const payLoad = {
        "method": "resetGameState",
        "gameId": gameId,
        "spectators": spectators,
        "players": players,
      }
      ws.send(JSON.stringify(payLoad));
    }

    window.addEventListener('load', (event) => {
      if(window.location.href.length > 22) {
        const str2 = window.location.href
        getRouteId = str2.substring(str2.length - 6)
        const payLoadRoute = {
          "method": "getRoute",
          "getRouteId": getRouteId,
        }
        ws.send(JSON.stringify(payLoadRoute)); 
      }
    });


    ws.onmessage = message => {
      // message.data
      const response = JSON.parse(message.data)
      console.log(response);
      // connect
      if (response.method === "connect") {
        clientId = response.clientId;
        theClient = response.theClient;
        console.log("Client id Set successfully " + clientId);

      }

      if (response.method === "leave") {
        game = response.game
        players = response.players
        spectators = response.spectators
        playerSlotHTML = response.playerSlotHTML
        playerSlotIndex = response.playerSlotIndex;
        reload = false;
        oldPlayerIndex = response.oldPlayerIndex
        gameOn = response.gameOn;


        $(".users-list-box:eq("+oldPlayerIndex+")").remove();


        for(let i = 0; i < players.length; i++) {
          if(players[i].hasLeft === true){
            if(playersCanPlay === false && players[i].clientId === clientDeal) {
              resetGameState();
            }
          }
        }


        if(gameOn === false) {
          if(playerSlotIndex === undefined || playerSlotIndex === null) {
            return;
          } else {
            playerSlot[playerSlotIndex].innerHTML = 
            `
            <div><button class="ready hide-element">PLACE BET</button></div>
            <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
            <div class="player-name hide-element"><span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
            <div class="player-sum"></div>
            <div class="player-coin hide-element"><div class="player-bet hide-element"></div></div>
            <div class="player-result hide-element"></div>
            <div class="player-cards">

            </div>
            `
          }          
        }


        // Add noclick class to the class that the player just left, IF the player currently sits on a slot
        if(players.some(e => e.clientId === clientId)) {
          if(!$(".empty-slot").is("noclick")) {
            $(".empty-slot").addClass("noclick");
            console.log("NO")
          } 
        }


        // If player not sits on a slot
        console.log("LEAVE")
          if(gameOn === true) {
            $(".empty-slot").addClass("noclick")

            if(playerSlotIndex === undefined || playerSlotIndex === null) {
              return;
            } else { 
              playerSlot[playerSlotIndex].classList.add("player-left", "plug");            
            }

          }

        if(game.players.length === 0 && $("#dealerSum").text().length > 0) {
          dealersTurn = true;
          sendDealersTurn();
          dealerPlay();
        }


        // if(players[players.findIndex(players => players.hasLeft === false)].clientId === clientId) {
        //   sendPlayerNext();
        // }
        if(gameOn === false && players.length > 0 && players.every(player => player.isReady)) {
          if(players[0].clientId === clientId && gameOn === false) startDeal();
        }


      }

      // create
      if (response.method === "create") {
        gameId = response.game.id;
        roomId = response.roomId;
        console.log(roomId)
        console.log(gameId)
        console.log("Game successfully created with id " + response.game.id);
      }


      // join
      if (response.method === "join") {
        console.log("asd")
        console.log(spectators)
        game = response.game;
        console.log(game.spectators)
        player = game.player
        spectators = game.spectators
        playerSlotHTML = response.playerSlotHTML
        roomId = response.roomId;

        roomId = gameId.substring(gameId.length - 6)
        window.history.pushState('game', 'Title', '/' + roomId);

      }

      // Assigns the "clientId" to "theClient" + some styling
      if(response.method === "joinClient") {
        theClient = response.theClient
        game = response.game
        players = response.players
        spectators = game.spectators
        console.log(spectators)
        playerSlotHTML = response.playerSlotHTML

        $('#invite-link').val(gameId);


        // get all the names and avatars for all the players currently on the table when client joins and a player already is on a slot
        setTimeout(function() {
          for(let i = 0; i < playerSlotHTML.length; i++) {
            for(let x = 0; x < spectators.length; x++) {
              if(spectators[x].clientId === playerSlotHTML[i]) {
                z = playerSlotHTML.indexOf(playerSlotHTML[i])
                if(spectators[x].nickname === "") spectators[x].nickname = "Player";
                playerSlot[z].firstElementChild.nextElementSibling.innerText = spectators[x].nickname
                playerSlot[z].firstElementChild.nextElementSibling.innerHTML += `<span><img class="player-avatar" src="/imgs/avatars/`+spectators[x].avatar+`.svg" alt="avatar"></span>`
              }
            }
          }
        }, 50)


        // Append users in room html
        for(let i = 0; i < spectators.length; i++) {
          if(spectators[i].nickname === "") spectators[i].nickname = "Player";
          $("#users-online-container").append(`
          <li class="users-list-box">
            <div class="users-list-info">
              <div class="user-list-name">`+spectators[i].nickname+`</div>
              <div>Balance: <span class="users-list-balance">`+spectators[i].balance+`</span></div>
            </div>
            <div class="users-list-img">
              <img src="/imgs/avatars/`+spectators[i].avatar+`.svg" alt="avatar">
            </div>
          </li>
          `);
          if(spectators[i].clientId === clientId) {
            $(".user-list-name:eq("+i+")").addClass("highlight")
          }
        }
      }


      // Updated players array (i.e. players[i] = theClient)
      if(response.method === "updateClientArray") {
        players = response.players
        newPlayer = response.newPlayer
        playerSlotHTML = response.playerSlotHTML


        console.log(newPlayer)
        console.log(newPlayer)
        console.log(newPlayer)
        // Update for players that already are in da game
        if(spectators.length > $("#users-online-container").children().length) {
          if(newPlayer.nickname === "") newPlayer.nickname = "Player";
          $("#users-online-container").append(`
          <li class="users-list-box">
            <div class="users-list-info">
              <div class="user-list-name">`+newPlayer.nickname+`</div>
              <div>Balance: <span class="users-list-balance">`+newPlayer.balance+`</span></div>
            </div>
            <div class="users-list-img">
              <img src="/imgs/avatars/`+newPlayer.avatar+`.svg" alt="avatar">
            </div>
          </li>
          `)
        }


      }


      // Update Style for users that join mid game
      if (response.method === "joinMidGame") {
        theClient = response.theClient
        game = response.game
        // spectators = game.spectators
        players = game.players
        playerSlotHTML = game.playerSlotHTML
        player = game.player
        dealer = game.dealer
        gameOn = game.gameOn
        // if(dealer.hiddenCard.length > 0) {
        //   dealerSlot.lastElementChild.innerHTML += 
        //   `
        //   <div class="hiddenCard">
        //     <img src="/imgs/Card_back.svg" alt="">
        //   </div>
        //   `;

        //   // dealerHiddenCard = document.querySelector(".hiddenCard")
        //   // dealerHiddenCardRemoveNext = true;
        //   }

        // Add invite link to input
        $('#invite-link').val(gameId);
        // Add label that says game is currently running
        $("#join-mid-game-label").removeClass("hide-element")


        // Append users in room html
        setTimeout(function() {
          for(let i = 0; i < spectators.length; i++) {
            if(spectators[i].nickname === "") spectators[i].nickname = "Player";
            $("#users-online-container").append(`
            <li class="users-list-box">
              <div class="users-list-info">
                <div class="user-list-name">`+spectators[i].nickname+`</div>
                <div>Balance: <span class="users-list-balance">`+spectators[i].balance+`</span></div>
              </div>
              <div class="users-list-img">
                <img src="/imgs/avatars/`+spectators[i].avatar+`.svg" alt="avatar">
              </div>
            </li>
            `);
            if(spectators[i].clientId === clientId) {
              $(".user-list-name:eq("+i+")").addClass("highlight")
            }
          }
        }, 200)




        // Show the Player on the table
          for(let x = 0; x < players.length; x++) {
            for(let i = 0; i < playerSlotHTML.length; i++) {
              if(players[x].clientId === playerSlotHTML[i]) {
                console.log(2)
                z = playerSlotHTML.indexOf(playerSlotHTML[i])
                if(playerSlot[z].firstElementChild.nextElementSibling.classList.contains("empty-slot")) playerSlot[z].firstElementChild.nextElementSibling.remove();
              }
            }
          }


        // get all the names and avatars for all the players currently on the table when client joins and a player already is on a slot
          for(let i = 0; i < playerSlotHTML.length; i++) {
            for(let x = 0; x < players.length; x++) {
              if(players[x].clientId === playerSlotHTML[i]) {
                z = playerSlotHTML.indexOf(playerSlotHTML[i])
                if(players[x].nickname === "") players[x].nickname = "Player";
                playerSlot[z].firstElementChild.nextElementSibling.innerText = players[x].nickname
                playerSlot[z].firstElementChild.nextElementSibling.innerHTML += `<span><img class="player-avatar" src="/imgs/avatars/`+players[x].avatar+`.svg" alt="avatar"></span>`
              }
            }
          }


          // UPDATE PLAYER CARDS IF A USER JOINS MID GAME
          for(let i = 0; i < players.length; i++) {
            for(let d = 0; d < deckImg.length; d++) {
              for(let c = 0; c < players[i].cards.length; c++) {

                if(players[i].cards[c].suit + players[i].cards[c].value.card === deckImg[d]) {
                  // Now apply the cards to the right table slot.
                  for(let s = 0; s < playerSlotHTML.length; s++) {
                    if(players[i].clientId === playerSlotHTML[s]) {
                      cardIndexJoin++
                      console.log(3)
                      playerSlot[s].lastElementChild.innerHTML += 
                      `<img class="cardImg` + " card" + cardIndexJoin + `" src="/imgs/` + deckImg[d] + `.svg" width="100" height="150">`;
                    }
                  }
                }
              }       
            }
          }

        // // UPDATE DEALER CARDS IF A USER JOINS MID GAME
        if(game.spectators.slice(-1)[0].clientId === clientId) {
          for(let d = 0; d < deckImg.length; d++) {
            for(let c = 0; c < dealer.cards.length; c++) {
              if(dealer.cards[c].suit + dealer.cards[c].value.card === deckImg[d]) {
                dealerSlot.lastElementChild.firstElementChild.innerHTML += 
                `<img class="dealerCardImg" src="/imgs/` + deckImg[d] + `.svg" width="100" height="150">`
              }
            }
          }
        }

        // Update DEALER HIDDEN CARD IF USER JOINS MID GAME
        if(dealer.hiddenCard.length === 0 || dealer.hiddenCard.length === undefined) {
          return;
        } else {
          dealerSlot.lastElementChild.firstElementChild.innerHTML +=
          `
          <div class="flip-card">
            <div class="flip-card-inner">
              <div class="flip-card-front">

              </div>
              <div class="flip-card-back">

              </div>
            </div>
          </div>
          `;
          $(".flip-card-front").html(`<img class="dealerCardImg" src="/imgs/Card_back.svg" width="100" height="150">`)
          // for(let d = 0; d < deckImg.length; d++) {
          //   for(let c = 0; c < dealer.cards.length; c++) {
          //     if(dealer.cards[c].suit + dealer.cards[c].value.card === deckImg[d]) {

          //     }
          //   }
          // }
          setTimeout(function() {
            console.log(dealersHiddenCard)
            $(".flip-card-back").html(`<img class="dealerCardImg" src="/imgs/`+ dealersHiddenCard +`.svg" width="100" height="150">`)
          }, 50)
          // $(".flip-card-back").html(`<img class="dealerCardImg" src="/imgs/`+ deck[0].suit + dealer.cards[1].value.card +`.svg" width="100" height="150">`)
          $(".dealer-cards").css('margin-left', '-=100px');
        }

        // Update player sum if user joins mid game
        if(dealer.sum > 0) {
        for(let i = 0; i < players.length; i++) {
          for(let s = 0; s < playerSlotHTML.length; s++) {
            if(players[i].clientId === playerSlotHTML[s]) {
              // playerSlot[s].firstElementChild.nextElementSibling.classList.remove("hide-element");
              playerSlot[s].firstElementChild.nextElementSibling.nextElementSibling.style.opacity = "1";
              playerSlot[s].firstElementChild.nextElementSibling.nextElementSibling.style.transform = "scale(1)";
            }
          }
        }
        // Update dealer sum if user joins mid game
          // $("#dealerSum").removeClass("hide-element")
          dealerSlot.firstElementChild.nextElementSibling.style.opacity = "1"
          dealerSlot.firstElementChild.nextElementSibling.style.transform = "scale(1)"          
        }

        // Update chips
        setPlayersBet()
        
        if(game.players.length === 0) {
          resetGame()
        }

      }

      if (response.method === "joinMidGameUpdate") {
        spectators = response.spectators;
        newPlayer = response.newPlayer;
        console.log(players)
        console.log(currentPlayer)

        if(players.length > 0) {
        // Send dealersHiddenCard to the new player who joined
        const payLoad = {
          "method": "dealersHiddenCard",
          "spectators": spectators,
          "dealersHiddenCard": dealersHiddenCard
        }
        if(players[players.findIndex(players => players.hasLeft === false)].clientId === clientId) {
          ws.send(JSON.stringify(payLoad));          
        }
        console.log("A PLAYER JOINED")
        // Reset the game if players array is not in the spectators array
        if(players.length === 1 && players[0].hasLeft === true) {
          // dry block of code, it just adds hasLeft to spectators array so we can later delete it in resetGame();
            for(let i = 0; i < players.length; i++) {
              for(let s = 0; s < spectators.length; s++) {
                if(players[i].hasLeft === true) {
                  if(spectators[s].clientId === players[i].clientId) {
                    spectators[s].hasLeft = true;
                  }
                }
              }
            }
          resetGame();
        }
        } else {
          resetGame();
        }
        
        // Update for players that already are in da game
        if(newPlayer.clientId === clientId) {
          // Do nothing
        } else {
          if(spectators.length > $("#users-online-container").children().length) {
            if(newPlayer.nickname === "") newPlayer.nickname = "Player";
            $("#users-online-container").append(`
            <li class="users-list-box">
              <div class="users-list-info">
                <div class="user-list-name">`+newPlayer.nickname+`</div>
                <div>Balance: <span class="users-list-balance">`+newPlayer.balance+`</span></div>
              </div>
              <div class="users-list-img">
                <img src="/imgs/avatars/`+newPlayer.avatar+`.svg" alt="avatar">
              </div>
            </li>
            `)
          }          
        }


      }

    if (response.method === "dealersHiddenCard") {
      dealersHiddenCard = response.dealersHiddenCard
    }

      // bet
      if (response.method === "bet") {
        players = response.players;

        // Assign players balance to the list
        for(let i = 0; i < spectators.length; i++) {
          for(let x = 0; x < players.length; x++) {
            if(spectators[i].clientId === players[x].clientId) {
              spectators[i].balance = players[x].balance
            }
          }
          $(".users-list-balance:eq("+i+")").text(spectators[i].balance)
          if(spectators[i].balance === 0) $(".users-list-balance:eq("+i+")").addClass("color-red")
        }

      }
      // deck
      if (response.method === "deck") {
        players = mapOrder(players, playerSlotHTML, 'clientId');
        deck = response.deck;
        clientDeal = response.clientDeal
        gameOn = response.gameOn

                // Optimize this later so it doesnt fire like every second
        if(gameOn) {
          for(let i = 0; i < players.length; i++) {
            if(players[i].clientId === clientId) {
              $("#bets-container").addClass("noclick");
            }
          }
          $(".empty-slot").addClass("noclick");
          $("#leave-table").addClass("noclick");
          $("#deal-start-label").addClass("hide-element")
        }
      }

      if (response.method === "isReady") {
        players = response.players;
        setPlayersBet()
        if(players.length > 1 && players.every(player => player.isReady) === false && timerStarted === false) {
          timerStarted = true;
          startTimer()
        }
      }

      if (response.method === "hasLeft") {
        players = response.players;
        spectators = response.spectators;
      }

      // currentPlayer
      if (response.method === "currentPlayer") {
        player = response.player;

      }

      if(response.method === "updatePlayerCards") {
        dealingSound.play();
        resetCards = response.resetCards
        players = response.players
        player = response.player

        if(player !== undefined) cardIndex = player.cards.length;

        for(let i = 0; i < playerSlotHTML.length; i++) {

          if(player.clientId === playerSlotHTML[i]) {
            z = playerSlotHTML.indexOf(playerSlotHTML[i])

            for(let c = 0; c < deckImg.length; c++) {
              if(player.cards.slice(-1)[0].suit + player.cards.slice(-1)[0].value.card === deckImg[c]) {
                playerSlot[z].lastElementChild.innerHTML += 
                `<img class="cardImg` + " card" + cardIndex + ` cardAnimation" src="/imgs/` + deckImg[c] + `.svg" width="100" height="150">`;

              }
            }

            // Animation
            setTimeout(function() {
              $(".players:eq("+playerSlotHTML.indexOf(playerSlotHTML[i])+") .player-cards").children().removeClass("cardAnimation")
            }, 50)

          }
        }
        // Animation
        // // console.log(z)
        // setTimeout(function() {
        //   // console.log(z)
        //   $(".players:eq("+z+") .player-cards").children().removeClass("cardAnimation")
        // }, 50)
        


        // $(".player-cards:eq("+z+")").children().removeClass("cardAnimation")
        // playerSlot[z].lastElementChild.children.classList.remove("cardAnimation")
        // if(resetCards === true) {
        //   for(let s = 0; s < playerSlot.length; s++) {
        //     playerSlot[s].lastElementChild.innerHTML = ""
        //   }
        //   dealerSlot.lastElementChild.lastElementChild.innerHTML = "";
        //   resetCards = false;
        // }

      }

      if (response.method === "updateDealerCards") {
        dealingSound.play();
        // dealerHiddenCardRemoveNext = response.dealerHiddenCardRemoveNext
        dealersTurn = response.dealersTurn
        if(dealersTurn === false) {
          dealer = response.dealer
        } else {
          player = response.player
          dealer = player
        }

        // if(dealer.cards.length === 2 && dealerHiddenCardRemoveNext === true) {
        //   dealerHiddenCard.remove()
        //   dealerHiddenCardRemoveNext = false;
        // }
        // $(".flip-card-inner").css('transform') == 'rotateY(-180deg)'
        if(dealer.hiddenCard.length === 0 || dealer.hiddenCard.length === undefined) {
          
        if($(".flip-card-inner").css('transform') !== "none" || dealer.cards.length === 1) {
            for(let c = 0; c < deckImg.length; c++) {
            if(dealer.cards.slice(-1)[0].suit + dealer.cards.slice(-1)[0].value.card === deckImg[c]) {
              dealerSlot.lastElementChild.firstElementChild.innerHTML += 
              `<img class="dealerCardImg cardAnimationDealer" src="/imgs/` + deckImg[c] + `.svg" width="100" height="150">`
            }
          }      
        }
        // Animation
        setTimeout(function() {
          $(".visibleCards").children().removeClass("cardAnimationDealer")
        }, 50)

        if(dealer.hiddenCard.length === 0 && dealer.cards.length === 2) {
          $(".flip-card-inner").css('transform', 'rotateY(-180deg)');
        } else {
          $(".dealer-cards").css('margin-left', '-=50px');  
        }

        } else {
          // dealerSlot.lastElementChild.innerHTML += 
          dealerSlot.lastElementChild.firstElementChild.innerHTML +=
          `
          <div class="flip-card cardAnimationDealer">
            <div class="flip-card-inner">
              <div class="flip-card-front">

              </div>
              <div class="flip-card-back">

              </div>
            </div>
          </div>
          `;

          // setTimeout(function() {
            $(".flip-card-front").html(`<img class="dealerCardImg" src="/imgs/Card_back.svg" width="100" height="150">`)
            $(".flip-card-back").html(`<img class="dealerCardImg" src="/imgs/`+ dealer.hiddenCard[0].suit + dealer.hiddenCard[0].value.card +`.svg" width="100" height="150">`)
            dealersHiddenCard = dealer.hiddenCard[0].suit + dealer.hiddenCard[0].value.card
          // }, 1)
          setTimeout(function() {
            $(".flip-card").removeClass("cardAnimationDealer")
          }, 50)

          // dealerSlot.lastElementChild.firstElementChild.innerHTML += 
          //   `<img class="dealerCardImg" src="/imgs/` + deckImg[c] + `.svg">`
          // `<img class="dealerCardImg" src="/imgs/Card_back.svg">`;
          // `
          // <div class="hiddenCard ">
          //   <img src="/imgs/Card_back.svg" alt="">
          // </div>
          // `;
          $(".dealer-cards").css('margin-left', '-=50px');
        // Animation
        setTimeout(function() {
          $(".hiddenCard").removeClass("cardAnimationDealer")
        }, 50)

          // dealerHiddenCard = document.querySelector(".hiddenCard")
          // dealerHiddenCardRemoveNext = true;
        }


      }



      // update
      if (response.method === "update") {
        players = response.players;
        dealer = response.dealer;
        deck = response.deck;
        gameOn = response.gameOn;
        
        // If every player in players arras has left, reset game
        setTimeout(function() {
          if(players.every(player => player.hasLeft)) {
            resetGame();
          }
        }, 50)


      }

      // the playe
      if (response.method === "thePlay") {
        console.log("the Play")
        player = response.player;
        currentPlayer = response.currentPlayer;
        playersCanPlay = true;

          // Highlight current player sum so we know who's turn it is
          $(".player-sum").removeClass("current-player-highlight")
          $(".players-timer circle").removeClass("circle-animation")
          for(let i = 0; i < playerSlotHTML.length; i++) {
            if(playerSlotHTML[i] === player.clientId) {
              $(".player-sum:eq("+i+")").addClass("current-player-highlight")
              setTimeout(function() {
                $(".players-timer:eq("+i+") circle").addClass("circle-animation")
              }, 50)
            }
          }

          if(dealersTurn) {
            return;
          } else {
            if(player.clientId === clientId && player.sum < 21 || player.clientId === clientId && theClient.sum.length > 1) {
              clicked = false;
              console.log("ITS YOUR TURN")
              thePlay()
            } else if(player.clientId === clientId && player.sum >= 21) {
              console.log("you blackjacked or busted")
              sendPlayerNext()
            } else {
              clicked = true;          
              console.log("WAIT FOR YOUR TURN")    
            }          
          }


        for(let i = 0; i < players.length; i++) {
          if(players[currentPlayer] !== undefined && players[currentPlayer].hasLeft === true) {
            currentPlayer = currentPlayer+1;
            console.log(1)
            player = players[currentPlayer];
          } else {
            break;
          }
        }


        


      }

      if (response.method === "sendPlayerNextWs") {

      }

      if(response.method === "showSum") {
        players = response.players;

         // Show sum for each player
        for(let i = 0; i < playerSlotHTML.length; i++) {
          playerSlot[i].firstElementChild.nextElementSibling.nextElementSibling.style.opacity = "1"
          playerSlot[i].firstElementChild.nextElementSibling.nextElementSibling.style.transform = "scale(1)"
        }
        // Show dealers sum
        dealerSlot.firstElementChild.nextElementSibling.style.opacity = "1"
        dealerSlot.firstElementChild.nextElementSibling.style.transform = "scale(1)"
      }

      // Join Table
      if(response.method === "joinTable") {
        console.log(theClient.bet)
        game = response.game;
        console.log(theClient.bet)
        spectators = response.spectators
        players = response.players
        theSlot = response.theSlot
        console.log(theClient.bet)
        user = response.user
        console.log(theClient.bet)
        // theClient = response.theClient
        playerSlotHTML = response.playerSlotHTML

        // Set player Name & player Avatar when someone joins table
        for(let i = 0; i < playerSlotHTML.length; i++) {
          for(let x = 0; x < players.length; x++) {
            if(players[x].clientId === playerSlotHTML[i]) {
              z = playerSlotHTML.indexOf(playerSlotHTML[i])
              if(players[x].nickname === "") players[x].nickname = "Player";
              playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.innerText = players[x].nickname
              playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.innerHTML += `<span><img class="player-avatar" src="/imgs/avatars/`+players[x].avatar+`.svg" alt="avatar"></span>`
            }
          }
        }
        console.log(theClient.bet)
      }

      if(response.method === "dealersTurn") {
        dealersTurn = response.dealersTurn
        console.log(dealersTurn)
        if(dealersTurn === true) {
          $(".players-timer circle").removeClass("circle-animation")
          $(".player-sum").removeClass("current-player-highlight");
          $("#dealerSum").addClass("current-player-highlight");
        }
      }
      
      // Checks if party room is full
      if(response.method === "playersLength") {
            playersLength = response.playersLength
          }

      if(response.method === "playerResultNatural") {
        players = response.players;
        playerNaturalIndex = response.playerNaturalIndex;
        $(".player-result:eq("+playerNaturalIndex+")").removeClass("hide-element")
        $(".player-result:eq("+playerNaturalIndex+")").addClass("result-blackjack")
        $(".player-result:eq("+playerNaturalIndex+")").text("BJ")
      }

      if(response.method === "finalCompare") {
        console.log("final compare go")
        finalCompareGo();
      }

      if(response.method === "resetGameState") {
        game = response.game
        resetGame();  
      }

      if(response.method === "redirect") {
        window.location.href = "/";
      }

      if(response.method === "startTimer") {
        startTimer()
      }
      



      // This updates theClient and players array accordingly
      if (response.method === "connect" || response.method === "create" || response.method === "joinClient" || response.method === "join" || response.method === "playersLength" || response.method === "playerResult" || response.method === "playerResultNatural" || response.method === "getRoute") {
        return;
      } else {
        console.log(theClient.bet)
        updateAllPlayers()
        syncTheGame()
      }

    } // <------ End of ws message listener

    // Keep everything in sync
    function updateAllPlayers() {

      // // UPDATE SPECTATORS STATUS (IMPORTANT TO HAVE THIS AVOVE PLAYERS STATUS, ELSE IT WILL OVERRIDE)
      for(let i = 0; i < spectators.length; i++) {
        if(spectators[i].clientId === clientId) {
          spectators[i].bet = theClient.bet
          theClient = spectators[i]
        }
      }

      // // UPDATE PLAYERS STATUS
      for(let i = 0; i < players.length; i++) {
        if(players[i].clientId === clientId) {
          players[i].bet = theClient.bet
          theClient = players[i]
        }

        // Keep the values for game array in sync, so when a player joins mid game, everything will display correctly.
        // for(let g = 0; g < game.players.length; g++) {
        //   game.players[g].cards = players[i].cards 

        // }
      }



      // UPDATE STYLE ON TABLE
      for(let i = 0; i < playerSlotHTML.length; i++) {
        if(playerSlotHTML[i] === clientId) clientId = playerSlotHTML[i];
        
        for(let x = 0; x < players.length; x++) {
          if(players[x].clientId === playerSlotHTML[i]) {
            z = playerSlotHTML.indexOf(playerSlotHTML[i])
            if(playerSlot[z].firstElementChild.nextElementSibling.classList.contains("empty-slot")) playerSlot[z].firstElementChild.nextElementSibling.remove();
            playerSlot[z].firstElementChild.nextElementSibling.classList.remove("hide-element")
            playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.classList.remove("hide-element")
            // playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.classList.remove("hide-element")
            playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.innerHTML = players[x].sum
            console.log("asd")
            // console.log(playerSlot[z].firstElementChild.nextElementSibling.innerHTML)
            // playerSlot[z].firstElementChild.nextElementSibling.innerHTML += `<span><img class="player-avatar" src="/imgs/avatars/`+players[x].avatar+`.svg" alt="avatar"></span>`
            // console.log(playerSlot[z].firstElementChild.nextElementSibling.innerHTML)
            // playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.innerHTML = players[x].bet
            // Player busts
            if(players[x].sum > 21) {
              $(".player-result:eq("+z+")").removeClass("hide-element")
              $(".player-result:eq("+z+")").addClass("result-lose")
              $(".player-result:eq("+z+")").text("BUST")        
            }
   
          }
        }
      }

      // Update Dealer Sum
      dealerSlot.firstElementChild.nextElementSibling.innerHTML = dealer.sum
      // Update player
      player = players[currentPlayer]
      // Keep user style balance in sync
      if(theClient.blackjack === false) $("#balance").text(theClient.balance);
    }

    // Keep game.(property) in sync with the actual game, so when a new client joins mid game, all "LOGIC" will syn.
    function syncTheGame() {
      const syncGame = {
        "method": "syncGame",
        "gameId": gameId,
        "player": player,
        "players": players,
        "spectators": spectators,
        "playerSlotHTML": playerSlotHTML,
        "dealer": dealer,
        "gameOn": gameOn
        }
      ws.send(JSON.stringify(syncGame));          
    }

    // Player joins a slot on the table
    for(let s = 0; s < playerSlot.length; s++) {
      (function(index){
        playerSlot[s].addEventListener("click", function() {
          console.log(this)
          if(joined === false && this.firstElementChild.nextElementSibling.classList.value === "empty-slot" && gameOn === false) {
            joined = true;
            theSlot = index
            joinTable();
            // Make player text yellow
            $(this).children("div:nth-child(3)").addClass("highlight")
            $("#bets-container").removeClass("noclick")
            $("#leave-table").removeClass("noclick")
            $(".empty-slot").addClass("noclick");
          }
        })
      })(s)
    }

    function setPlayersBet() {

      for(let s = 0; s < playerSlotHTML.length; s++) {
        for(let i = 0; i < players.length; i++) {
          if(players[i].isReady && players[i].clientId === playerSlotHTML[s]) {
            console.log("player " + s + " is ready")
            // players[i].isReady = false;
            if(players[i].bet >= 10 && players[i].bet < 50) {chipIndex = "White"} else 
            if(players[i].bet >= 50 && players[i].bet < 100) {chipIndex = "Red"} else 
            if(players[i].bet >= 100 && players[i].bet < 500) {chipIndex = "Blue"} else 
            if(players[i].bet >= 500 && players[i].bet < 1000) {chipIndex = "Green"} else 
            if(players[i].bet >= 1000 && players[i].bet < 5000) {chipIndex = "Gray"} else 
            if(players[i].bet >= 5000 && players[i].bet < 10000) {chipIndex = "Orange"} else 
            if(players[i].bet >= 10000 && players[i].bet < 50000) {chipIndex = "Purple"} else 
            if(players[i].bet >= 50000 && players[i].bet < 100000) {chipIndex = "Brown"} else 
            if(players[i].bet >= 100000) {chipIndex = "Black"};
            $(".players:eq("+s+") .player-bet").text(players[i].bet)
            console.log("hahaha")
            $(".players:eq("+s+") .player-coin").css("background", "url(/imgs/chips/Casino_Chip_" + chipIndex + ".svg)")
            console.log(players[i].bet)
            if(players[i].bet > 999) {
              $(".players:eq("+s+") .player-coin").html($(".players:eq("+s+") .player-bet").text().slice(0, -3) + "K" + `<div class="player-bet hide-element"></div>`);
            } else {
              $(".players:eq("+s+") .player-coin").html($(".players:eq("+s+") .player-bet").text() + `<div class="player-bet hide-element"></div>`);
            }
            $(".players:eq("+s+") .player-bet").text(players[i].bet)

            setTimeout(function() {
              console.log("PLAYER COIN ANIMATION")
              $(".players:eq("+s+") .player-coin").addClass("player-coin-animation")
            }, 50)
            
          }
        }
      }

    }



    setTimeout(joinByUrl, 200)
    function joinByUrl() {
      // If player has a roomId in his url
      if(window.location.href.length > 22) {

        // Get last 6 values from url
        const str = window.location.href
        roomId = str.substring(str.length - 6)
        gameId = "http://localhost:8081/" + roomId;

        // To prevent bug at 714
        playerSlotIndex = [];

      }
    }

    // Before player exits/resets window, terminate him from the room
    window.addEventListener('beforeunload', function() {
      reload = true;
      theClient.hasLeft = true;
      if(playersCanPlay === true && player.clientId === clientId && players.length > 1) {
        sendPlayerNext();
        console.log("sendPlayerNext")
      }
      terminatePlayer();
      // Dont add more code below terminatePlayer(), its dangerous
    });

  </script>

  <!-- Sounds -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.0/howler.min.js"></script>
  <script>
    let dealingSound = new Howl({
      src: ['sounds/dealing_card_fix3.mp3']
    });
    let chipHover = new Howl({
      src: ['sounds/chip_hover_fix.mp3']
    });
    let chipPlace = new Howl({
      src: ['sounds/chip_place.mp3']
    });
    let youWin = new Howl({
      src: ['sounds/you_win.mp3']
    });
    let youLose = new Howl({
      src: ['sounds/you_lose.mp3']
    });
    let actionClick = new Howl({
      src: ['sounds/actionClick.mp3']
    });
    let defaultClick = new Howl({
      src: ['sounds/click_default.mp3']
    });
    let clickFiller = new Howl({
      src: ['sounds/click_filler.mp3']
    });
    let timerRunningOut = new Howl({
      src: ['sounds/timer_running_out.mp3']
    });

    $(".betButtons").hover(function() {
      chipHover.play();
      }, function () {
        // play nothing when mouse leaves chip
    });



  </script>
</body>
</html>
