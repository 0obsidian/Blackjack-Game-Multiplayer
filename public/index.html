<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackjack21.io</title>
  <!-- <link rel="stylesheet" href="/css/lib/normalize.css"> -->
  <link rel="stylesheet" href="/css/dist/style.css">
  <link rel="stylesheet" href="/css/style.scss">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div id="info-rules">
    <div id="how-to-play">
      HOW TO PLAY
    </div>
    <div id="info-rules-overflow">
    <div>
      <h1 id="h1margin">OBJECT OF THE GAME</h1>
      <P>
        Each participant attempts to beat the dealer by getting a count as close to 21 as possible, without going above 21.
      </P>
    </div>
    <div>
      <h1>CARD VALUES/SCORING</h1>
      <p>
        Usually it's up to each individual player if an ace is worth 1 or 11. However in this game if a player stands with an ace, it will always count the ace as 11 if your total sum doesn't exceed 21. Face cards are 10 and any other card is its original value.</p>
    </div>
    <div>
      <h1>BETTING</h1>
      <p>
        Before the dealer begins dealing out cards, each player must place a bet and hit ready.</p>
    </div>
    <div>
      <h1>THE DEAL</h1>
      <p>
        The round starts with the dealer giving out 2 cards to each player. He also gives himself one card facing up & one card facing down.</p>
    </div>
    <div>
      <h1>NATURALS</h1>
      <p>
        When the intial 2 cards has been dealt: If a player gets a count to 21 on the first 2 cards, the player gets whats called Blackjack. Blakjack pays out 3:2 directly to the player and he will wait until next round to play again.</p>
    </div>
    <div>
      <h1>THE PLAY</h1>
      <p>
        Now its time for the first player to make his move.
        The player can Hit, Stand, Or Double Down.
        <ul>
          <li><strong>Hit</strong> = ask for another card in attempt to get closer to 21.</li>
          <li><strong>Stand</strong> = Don't ask for any cards, moves on to the next player</li>
          <li><strong>Double Down</strong> = Double the bet and ask for another card. (Can only double down once per round & can't draw any more cards after double'd down).</li>
        </ul>
      </p>
    </div>
    <div>
      <h1>THE DEALER'S PLAY</h1>
      <p>
        Dealer starts with taking his card facing down. Dealer will draw until he reaches 17, when dealer's sum is 17 or above, he stops taking cards.
      </p>
    </div>
    <div>
      <h1>PAYOUT</h1>
      <p>
        <ul>
          <li>If the player busts, he will lose his bet, even if the dealer also busts.</li>
          <li>If player has higher value cards than the dealer, the player wins.</li>
          <li>If dealer has higher value cards than the player, the dealer wins.</li>
        </ul>
      </p>
    </div>
  </div>
  </div>

  <div id="main-menu">
    <img id="blackjack-title" src="/imgs/blackjack21io.png" alt="blackjack21.io">
    <div id="main-box">
      <div id="avatar-box">
        <i class="fas fa-chevron-left"></i>
        <img src="/imgs/avatars/zimmster.png" alt="avatar" width="80">
        <i class="fas fa-chevron-right"></i>
      </div>
      <div>
        <input id="nickname" type="text" placeholder="Nickname">
      </div>
      <div>
        <button id="btnOffline" class="play-btns "><span><i class="fas fa-user"></i></span>Play Offline</button>
      </div>
      <div>
        <button id="btnCreate" class="play-btns "><span><i class="fas fa-users"></i></span>Create Room</button>
      </div>
      <div>
        <button id="btnJoin" class="play-btns hide-element"><span><i class="fas fa-users"></i></span>Join Room</button>
      </div>
    </div>
    <div id="about-box">
      <strong>blackjack21.io</strong> is a free multiplayer casino game.
      <ul>
        <strong>NOTE:</strong>
        <li>Every game uses ONE standard 52-card pack that shuffles every round.</li>
        <li>Current version of the game does not support Splitting Cards & Insurance.</li>
        <li>2 aces on the first two cards gives you blackjack (21).</li>
        <li>A private room can consist up to 7 players.</li>
      </ul>
      <button id="about">
        About
      </button>
    </div>
  </div>

  <div id="game-room" class="hide-element">
  <div id="player-result-big" class="hide-element">
    <div id="player-result-big-answer"></div>
    <div id="player-result-sum-box">
      <span id="player-result-big-plus-minus"></span>
      <span id="player-result-big-sum"></span>
    </div>
  </div>
  <div id="dealer">
    <h1>Dealer</h1>
    <div id="dealerSum">sum here</div>
    <div class="dealer-cards">
      <div class="visibleCards">
        <!-- <img class="dealerCardImg" src="/imgs/Spade3.svg">
        <img class="dealerCardImg" src="/imgs/Spade3.svg">
        <img class="dealerCardImg" src="/imgs/Spade3.svg"> -->
      </div>
    </div>
  </div>
  <button id="play">Play</button>
  <div>
    <button class="userAction" id="stand">Stand</button>
    <button class="userAction" id="hit">Hit</button>
    <button class="userAction" id="doubleDown">Double Down</button>
  </div>
  <div>
    <button class="countAce">Count as 1</button>
    <button class="countAce">Count as 11</button>
  </div>
  <div id="players-container">
    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element"><span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element"><span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element"><span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-result hide-element">WIN</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element"><span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">21</div>
      <div class="player-bet hide-element"></div>
      <div class="player-result hide-element">BJ</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element"><span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-bet hide-element">
        100k
        <!-- <div class="player-bet-chip">100K</div> -->
        <!-- <div class="player-bet-chip">
          <img src="/imgs/chips/Casino_Chip_Brown.svg" alt="chip">
        </div> -->
      </div>
      <div class="player-result hide-element">LOSE</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element"><span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div><button class="ready hide-element">PLACE BET</button></div>
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element"><span class="hide-element"><img class="player-avatar" src="" alt="avatar"></span></div>
      <div class="player-sum">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-result hide-element">Win/Lose/Draw</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
  </div>
  <div id="bets-container" class="noclick">
    <span>
      <button class="max-clear update-balance-bet">CLEAR</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip10" value="10">10</button>
      <!-- <img src="/imgs/chips/Casino_Chip_White2.svg" alt="">    -->
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip50" value="50">50</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip100" value="100">100</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip500" value="500">500</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip1k" value="1000">1K</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip5k" value="5000">5K</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip10k" value="10000">10K</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip50k" value="50000">50K</button>
    </span>
    <span>
      <button class="betButtons update-balance-bet" id="chip100k" value="100000">100K</button>
    </span>
    <span>
      <button class="max-clear update-balance-bet">MAX</button>
    </span>


  </div>
  <button id="leave-table">Leave Table</button>
  <!-- <div id="dealer">
    <h2>Dealer</h2>
    <div id="dealerSum">sum here</div>
    <div class="dealer-cards">
      <div class="visibleCards">

      </div>
 
    </div>
  </div> -->
  <div>
      <button>Go To Table</button>
  </div>
  <div id="balance-bet-box">
    <div class="balance-bet">
      Balance
      <div id="balance"></div>
    </div>
    <div class="balance-bet">
      Total Bet
      <div id="total-bet"></div>
    </div>
  </div>


</div>

<!-- PRE-LOAD DECK IMAGES -->
<div class="hidden">
	<script>
			var images = new Array()
			function preload() {
				for (i = 0; i < preload.arguments.length; i++) {
					images[i] = new Image()
					images[i].src = preload.arguments[i]
				}
			}
			preload(
        "/imgs/Heart2.svg",
        "/imgs/Heart3.svg",
        "/imgs/Heart4.svg",
        "/imgs/Heart5.svg",
        "/imgs/Heart6.svg",
        "/imgs/Heart7.svg",
        "/imgs/Heart8.svg",
        "/imgs/Heart9.svg",
        "/imgs/Heart10.svg",
        "/imgs/HeartJ.svg",
        "/imgs/HeartQ.svg",
        "/imgs/HeartK.svg",
        "/imgs/HeartA.svg",
        "/imgs/Diamond2.svg",
        "/imgs/Diamond3.svg",
        "/imgs/Diamond4.svg",
        "/imgs/Diamond5.svg",
        "/imgs/Diamond6.svg",
        "/imgs/Diamond7.svg",
        "/imgs/Diamond8.svg",
        "/imgs/Diamond9.svg",
        "/imgs/Diamond10.svg",
        "/imgs/DiamondJ.svg",
        "/imgs/DiamondQ.svg",
        "/imgs/DiamondK.svg",
        "/imgs/DiamondA.svg",
        "/imgs/Spade2.svg",
        "/imgs/Spade3.svg",
        "/imgs/Spade4.svg",
        "/imgs/Spade5.svg",
        "/imgs/Spade6.svg",
        "/imgs/Spade7.svg",
        "/imgs/Spade8.svg",
        "/imgs/Spade9.svg",
        "/imgs/Spade10.svg",
        "/imgs/SpadeJ.svg",
        "/imgs/SpadeQ.svg",
        "/imgs/SpadeK.svg",
        "/imgs/SpadeA.svg",
        "/imgs/Club2.svg",
        "/imgs/Club3.svg",
        "/imgs/Club4.svg",
        "/imgs/Club5.svg",
        "/imgs/Club6.svg",
        "/imgs/Club7.svg",
        "/imgs/Club8.svg",
        "/imgs/Club9.svg",
        "/imgs/Club10.svg",
        "/imgs/ClubJ.svg",
        "/imgs/ClubQ.svg",
        "/imgs/ClubK.svg",
        "/imgs/ClubA.svg"
			)
	</script>
</div>


  <script type="text/javascript" src="js/lib/jquery-3.5.1.min.js"></script>
  <script type="text/javascript" src="/js/app.js"></script>

  <script>
    // HTML elements
    let clientId = null;
    let gameId = null;
    let roomId = null;
    let theClient = null;
    players = [];
    spectators = [];
    playerSlotHTML = [];

    let clicked = null;
    let doubleDown = null;
    let reload = null;
    let cardIndex = null;
    let cardIndexJoin = 1;
    let playerNaturalIndex = null;

    let ws = new WebSocket("ws://localhost:8080")
    const btnCreate = document.getElementById("btnCreate");
    const btnJoin = document.getElementById("btnJoin");
    const txtGameId = document.getElementById("txtGameId");
    const divPlayers = document.getElementById("divPlayers");
    const divBoard = document.getElementById("divBoard");

    // CSS
    let nickname = document.querySelector("#nickname");
    let playersLength = null;
    let theSlot = null;
    let z = null; // last player table index
    let aPlayer = null;
    let joined = false;
    let playerSlot = document.querySelectorAll(".players")
    let playerCards = document.querySelectorAll(".player-cards")
    let dealerCards = document.querySelectorAll(".dealer-cards")
    let dealerSlot = document.querySelector("#dealer")
    let playerName = document.querySelectorAll(".player-name")
    let dealerHiddenCard = null;
    let dealerHiddenCardRemoveNext = false;
    let resetCards = false;

    const leaveTable = document.querySelector("#leave-table")
    // CSS

    // wiring events
    btnJoin.addEventListener("click", (e) => {
      const payLoadLength = {
        "method": "playersLength",
        "gameId": gameId
      }
      ws.send(JSON.stringify(payLoadLength));

      // Set 50ms delay so above method response before below function starts
      setTimeout(function() {
        if(playersLength >= 7) {
        alert("Game Is full!")
        return;
      } else {
        playerJoin()
        setTimeout(function() {
          $("#main-menu").addClass("hide-element")
          $("#game-room").removeClass("hide-element")
          }, 500)
        }
      }, 50)
    });
    function playerJoin() {
      nickname = nickname.value
      theClient.nickname = nickname.value
      if (gameId === null) {
        gameId = txtGameId.value;
      }
      const payLoad = {
        "method": "join",
        "clientId": clientId,
        "gameId": gameId,
        "roomId": roomId,
        "theClient": theClient,
        "playerSlot": playerSlot,
        "playerSlotHTML": playerSlotHTML, 
        "players": players,
        "spectators": spectators,
        "nickname": nickname
      }
      ws.send(JSON.stringify(payLoad));
    }

    btnCreate.addEventListener("click", (e) => {
      const payLoad = {
        "method": "create",
        "clientId": clientId,
        "theClient": theClient,
        "playerSlot": playerSlot,
        "playerSlotHTML": playerSlotHTML,
        "roomId": roomId
      }
      ws.send(JSON.stringify(payLoad));

      // setTimeout(playerJoin, 500)
      setTimeout(function() {
      playerJoin()
      $("#main-menu").addClass("hide-element")
      $("#game-room").removeClass("hide-element")
      }, 500)
    });

    leaveTable.addEventListener("click", (e) => {
      joined = false;
      $("#bets-container").addClass("noclick");
      $(".empty-slot").removeClass("noclick");
      terminatePlayer();
    });


    function sendPlayerBets() {
      const payLoad = {
        "method": "bet",
        "players": players,
        "spectators": spectators
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updatePlayerCards() {
      const payLoad = {
        "method": "updatePlayerCards",
        "players": players,
        "spectators": spectators,
        "player": player,
        "resetCards": resetCards
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateDealerCards() {
      const payLoad = {
        "method": "updateDealerCards",
        "players": players,
        "spectators": spectators,
        "player": player,
        "dealer": dealer,
        "dealersTurn": dealersTurn,
        "dealerHiddenCardRemoveNext": dealerHiddenCardRemoveNext
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendPlayerDeck() {
      const payLoad = {
        "method": "deck",
        "players": players,
        "spectators": spectators,
        "deck": deck,
        "gameOn": gameOn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function clientIsReady() {
      theClient.isReady = true;
      console.log(theClient.isReady)
      console.log(theClient.isReady)
      console.log(theClient.isReady)
      console.log(theClient.isReady)
      console.log(theClient.isReady)

      const payLoad = {
        "method": "isReady",
        "players": players,
        "spectators": spectators,
        "theClient": theClient
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updatePlayers() {
      const payLoad = {
        "method": "update",
        "players": players,
        "spectators": spectators,
        "dealer": dealer,
        "deck": deck,
        "gameOn": gameOn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateCurrentPlayer() {
      const payLoad = {
        "method": "currentPlayer",
        "players": players,
        "spectators": spectators,
        "player": player,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendPlayerThePlay() {
      const payLoad = {
        "method": "thePlay",
        "players": players,
        "spectators": spectators,
        "player": player,
        "currentPlayer": currentPlayer,
        "theClient": theClient,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function joinTable() {
      const payLoad = {
        "method": "joinTable",
        "players": players,
        "spectators": spectators,
        "theClient": theClient,
        "theSlot": theSlot,
        "playerSlotHTML": playerSlotHTML,
        "gameId": gameId
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateTable() {
      const payLoad = {
        "method": "updateTable",
        "players": players,
        "spectators": spectators,
        "theClient": theClient,
        "theSlot": theSlot,
        "playerSlot": playerSlot,
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendDealersTurn() {
      const payLoad = {
        "method": "dealersTurn",
        "players": players,
        "spectators": spectators,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function terminatePlayer() {
      console.log("terminate")
      const payLoad = {
        "method": "terminate",
        "spectators": spectators,
        "theClient": theClient,
        "gameId": gameId,
        "playerSlotHTML": playerSlotHTML,
        // "players": players,
        "reload": reload
      }
      ws.send(JSON.stringify(payLoad));
    }

    function resetRound() {
      const payLoad = {
        "method": "resetRound",
        "spectators": spectators
      }
      ws.send(JSON.stringify(payLoad));
    }

    function playerResult() {
      const payLoad = {
        "method": "playerResult",
        "spectators": spectators,
        "players": players
      }
      ws.send(JSON.stringify(payLoad));
    }

    function playerResultNatural() {
      const payLoad = {
        "method": "playerResultNatural",
        "spectators": spectators,
        "players": players,
        "playerNaturalIndex": playerNaturalIndex
      }
      ws.send(JSON.stringify(payLoad));
    }

    function finalCompare() {
      const payLoad = {
        "method": "finalCompare",
        "spectators": spectators,
        "players": players,
      }
      ws.send(JSON.stringify(payLoad));
    }


    ws.onmessage = message => {
      // message.data
      const response = JSON.parse(message.data)
      console.log(response);
      // connect
      if (response.method === "connect") {
        clientId = response.clientId;
        theClient = response.theClient;
        console.log("Client id Set successfully " + clientId);

      }

      if (response.method === "leave") {
        console.log("leave")
        game = response.game
        players = game.players
        spectators = game.spectators
        playerSlotHTML = game.playerSlotHTML
        playerSlotIndex = response.playerSlotIndex;
        reload = false;

        if(playerSlotIndex === undefined) {
          return;
        } else {
          playerSlot[playerSlotIndex].innerHTML = 
          `
          <div><button class="ready hide-element">PLACE BET</button></div>
          <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
          <div class="player-name hide-element">A PLAYER</div>
          <div class="player-sum">sum here</div>
          <div class="player-bet hide-element">bet here</div>
          <div class="player-result hide-element">Win/Lose/Draw</div>
          <div class="player-cards">

          </div>
          `
        }
        // placeBet();
      }

      // create
      if (response.method === "create") {
        gameId = response.game.id;
        roomId = response.roomId;
        console.log(roomId)
        console.log(gameId)
        console.log("Game successfully created with id " + response.game.id);
      }

      // join
      if (response.method === "join") {
        game = response.game;
        // players = response.players
        spectators = response.spectators
        playerSlotHTML = response.playerSlotHTML
        roomId = response.roomId;

        roomId = gameId.substring(gameId.length - 6)
        window.history.pushState('game', 'Title', '/' + roomId);

      }

      // Assigns the "clientId" to "theClient" + some styling
      if(response.method === "joinClient") {

        theClient = response.theClient
        game = response.game

        // If client joins mid game
        if(game.gameOn === true) {
          gameOn = game.gameOn
          dealer = game.dealer
          player = game.player
          if(dealer.hiddenCard.length > 0) {
            dealerSlot.lastElementChild.innerHTML += 
          `
          <div class="hiddenCard">
            <img src="/imgs/Card_back.svg" alt="">
          </div>
          `;

          dealerHiddenCard = document.querySelector(".hiddenCard")
          dealerHiddenCardRemoveNext = true;
          }

          }
        }



      // Updated players array (i.e. players[i] = theClient)
      if(response.method === "updateClientArray") {
        players = response.players
        spectators = response.spectators
        playerSlotHTML = response.playerSlotHTML

      }


      // Update Style for users that join mid game
      if (response.method === "joinMidGame") {
        theClient = response.theClient
        game = response.game
        player = game.player

          // UPDATE PLAYER CARDS IF A USER JOINS MID GAME
          for(let i = 0; i < players.length; i++) {
          cardIndexJoin = 1;
            for(let d = 0; d < deckImg.length; d++) {
              for(let c = 0; c < players[i].cards.length; c++) {

                if(players[i].cards[c].suit + players[i].cards[c].value.card === deckImg[d]) {

                  // Now apply the cards to the right table slot.
                  for(let s = 0; s < playerSlotHTML.length; s++) {
                    if(players[i].clientId === playerSlotHTML[s]) {
                      playerSlot[s].lastElementChild.innerHTML += 
                      `<img class="cardImg` + " card" + cardIndexJoin++ + `" src="/imgs/` + deckImg[c] + `.svg">`;
                    }
                  }
                }
              }       
            }
          }

        // // UPDATE DEALER CARDS IF A USER JOINS MID GAME
        if(game.spectators.slice(-1)[0].clientId === theClient.clientId) {
          for(let d = 0; d < deckImg.length; d++) {
            for(let c = 0; c < dealer.cards.length; c++) {
              if(dealer.cards[c].suit + dealer.cards[c].value.card === deckImg[d]) {
                dealerSlot.lastElementChild.firstElementChild.innerHTML += 
                `<img class="dealerCardImg" src="/imgs/` + deckImg[d] + `.svg">`
              }
            }
          }
        }

        // Update player sum if user joins mid game
        if(dealer.sum > 0) {
        for(let i = 0; i < players.length; i++) {
          for(let s = 0; s < playerSlotHTML.length; s++) {
            if(players[i].clientId === playerSlotHTML[s]) {
              // playerSlot[s].firstElementChild.nextElementSibling.classList.remove("hide-element");
              playerSlot[s].firstElementChild.nextElementSibling.nextElementSibling.style.opacity = "1";
              playerSlot[s].firstElementChild.nextElementSibling.nextElementSibling.style.transform = "scale(1)";
            }
          }
        }
        // Update dealer sum if user joins mid game
          // $("#dealerSum").removeClass("hide-element")
          dealerSlot.firstElementChild.nextElementSibling.style.opacity = "1"
          dealerSlot.firstElementChild.nextElementSibling.style.transform = "scale(1)"          
        }
        

      }

      // bet
      if (response.method === "bet") {
        players = response.players;
        // spectators = response.spectators
      }
      // deck
      if (response.method === "deck") {
        deck = response.deck;
        gameOn = response.gameOn
      }

      if (response.method === "isReady") {
        players = response.players;

        for(let s = 0; s < playerSlotHTML.length; s++) {

          for(let i = 0; i < players.length; i++) {
            if(players[i].isReady && players[i].clientId === playerSlotHTML[s]) {
              console.log("player " + s + " is ready")
              // players[i].isReady = false;
              if(players[i].bet >= 10 && players[i].bet < 50) {chipIndex = "White"} else 
              if(players[i].bet >= 50 && players[i].bet < 100) {chipIndex = "Red"} else 
              if(players[i].bet >= 100 && players[i].bet < 500) {chipIndex = "Blue"} else 
              if(players[i].bet >= 500 && players[i].bet < 1000) {chipIndex = "Green"} else 
              if(players[i].bet >= 1000 && players[i].bet < 5000) {chipIndex = "Gray"} else 
              if(players[i].bet >= 5000 && players[i].bet < 10000) {chipIndex = "Orange"} else 
              if(players[i].bet >= 10000 && players[i].bet < 50000) {chipIndex = "Purple"} else 
              if(players[i].bet >= 50000 && players[i].bet < 100000) {chipIndex = "Brown"} else 
              if(players[i].bet >= 100000) {chipIndex = "Black"};

              $(".players:eq("+s+") .player-bet").css("background", "url(/imgs/chips/Casino_Chip_" + chipIndex + ".svg)")
              $(".players:eq("+s+") .player-bet").text(players[i].bet)
              setTimeout(function() {
                $(".players:eq("+s+") .player-bet").css("opacity", "1")
              }, 100)
              
            }
          }          
        }

      }

      // currentPlayer
      if (response.method === "currentPlayer") {
        player = response.player;
      }

      if(response.method === "updatePlayerCards") {
        resetCards = response.resetCards
        players = response.players
        player = response.player

        if(player !== undefined) cardIndex = player.cards.length;

        for(let i = 0; i < playerSlotHTML.length; i++) {

            if(player.clientId === playerSlotHTML[i]) {
              z = playerSlotHTML.indexOf(playerSlotHTML[i])

            for(let c = 0; c < deckImg.length; c++) {
              if(player.cards.slice(-1)[0].suit + player.cards.slice(-1)[0].value.card === deckImg[c]) {
                playerSlot[z].lastElementChild.innerHTML += 
                `<img class="cardImg ` + " card" + cardIndex + `" src="/imgs/` + deckImg[c] + `.svg">`
              }
            }

          }        
        }
        // if(resetCards === true) {
        //   for(let s = 0; s < playerSlot.length; s++) {
        //     playerSlot[s].lastElementChild.innerHTML = ""
        //   }
        //   dealerSlot.lastElementChild.lastElementChild.innerHTML = "";
        //   resetCards = false;
        // }

      }

      if (response.method === "updateDealerCards") {
        dealerHiddenCardRemoveNext = response.dealerHiddenCardRemoveNext
        dealersTurn = response.dealersTurn
        if(dealersTurn === false) {
          dealer = response.dealer
        } else {
          player = response.player
          dealer = player
        }

        if(dealer.cards.length === 2 && dealerHiddenCardRemoveNext === true) {
          dealerHiddenCard.remove()
          dealerHiddenCardRemoveNext = false;
        }
        if(dealer.hiddenCard.length === 0 || dealer.hiddenCard.length === undefined) {
        
          for(let c = 0; c < deckImg.length; c++) {
          if(dealer.cards.slice(-1)[0].suit + dealer.cards.slice(-1)[0].value.card === deckImg[c]) {
            dealerSlot.lastElementChild.firstElementChild.innerHTML += 
            `<img class="dealerCardImg" src="/imgs/` + deckImg[c] + `.svg">`
          }
        }
        } else {
          dealerSlot.lastElementChild.innerHTML += 
          `
          <div class="hiddenCard">
            <img src="/imgs/Card_back.svg" alt="">
          </div>
          `;

          dealerHiddenCard = document.querySelector(".hiddenCard")
          dealerHiddenCardRemoveNext = true;
        }

      }



      // update
      if (response.method === "update") {
        players = response.players;
        dealer = response.dealer;
        deck = response.deck;
        gameOn = response.gameOn;
        
      }

      // the playe
      if (response.method === "thePlay") {
        player = response.player
        currentPlayer = response.currentPlayer
        if(dealersTurn) {
          return;
        } else {
          if(player.clientId === theClient.clientId && player.sum < 21 || player.sum.length > 1) {
            clicked = false;
            setTimeout(function() { // remove timeout later if needed
              console.log("ITS YOUR TURN")
            }, 50)
            thePlay()
          } else if(player.clientId === theClient.clientId && player.sum >= 21) {
            console.log("you blackjacked or busted")
            sendPlayerNext()
          } else {
            clicked = true;          
            console.log("WAIT FOR YOUR TURN")    
          }          
        }

        // Show sum for each player
        for(let i = 0; i < playerSlotHTML.length; i++) {
            // Actually unhide hide element
              // playerSlot[i].firstElementChild.nextElementSibling.classList.remove("hide-element")
              // // Set opacity to 1 (for fade in animation purpose)
              // setTimeout(function () { // add 1ms timeout so fade in effect works
                playerSlot[i].firstElementChild.nextElementSibling.nextElementSibling.style.opacity = "1"
                playerSlot[i].firstElementChild.nextElementSibling.nextElementSibling.style.transform = "scale(1)"
              // }, 100)

        }
        // $("#dealerSum").removeClass("hide-element")
        // setTimeout(function () {
          dealerSlot.firstElementChild.nextElementSibling.style.opacity = "1"
          dealerSlot.firstElementChild.nextElementSibling.style.transform = "scale(1)"
        // }, 100)

      }

      // Join Table
      if(response.method === "joinTable") {
        game = response.game;
        spectators = response.spectators
        players = response.players
        theSlot = response.theSlot
        user = response.user
        theClient = response.theClient
        playerSlotHTML = response.playerSlotHTML



      }

      if(response.method === "dealersTurn") {
        dealersTurn = response.dealersTurn
      }

      if(response.method === "playersLength") {
            playersLength = response.playersLength
          }



      if(response.method === "playerResult") {
        players = response.players

        // if dealer sum.length === 2. Fix dealer sum before proceeding
        if(dealer.sum.length === 2 && dealer.sum[1] <= 21) {
          dealer.sum.shift()
          dealer.sum = dealer.sum[0]
        } else if(dealer.sum.length === 2 && dealer.sum[1] > 21) {
          dealer.sum.pop()
          dealer.sum = dealer.sum[0]
        }

        dealerSlot.firstElementChild.nextElementSibling.innerHTML = dealer.sum
        // // remove dealer from player
        players.splice(-1)[0]
        sendPlayerBets() // <--- this only updates players array
        console.log(players)
        console.log(players)
        console.log(players)
        console.log("show dealer cards")
        // For all players That have NOT busted, compare sum to dealer
        for(let i = 0; i < players.length; i++) {
          // exclude all players that already have blackjack
          if(players[i].blackjack === false) {
          if(players[i].cards.length > 0) {
            // Also check if dealer has bust
            if(dealer.sum > 21) {
              playerWin(i)
              console.log("DEALER BUST")
              for(let x = 0; x < playerSlotHTML.length; x++) {
                if(players[i].clientId === playerSlotHTML[x]) {
                  $(".player-result:eq("+x+")").removeClass("hide-element")
                  $(".player-result:eq("+x+")").addClass("result-win")
                  $(".player-result:eq("+x+")").text("WIN")
                }
              }
            } else if(dealer.sum < players[i].sum) {
              playerWin(i)
              console.log("player win")
              for(let x = 0; x < playerSlotHTML.length; x++) {
                if(players[i].clientId === playerSlotHTML[x]) {
                  $(".player-result:eq("+x+")").removeClass("hide-element")
                  $(".player-result:eq("+x+")").addClass("result-win")
                  $(".player-result:eq("+x+")").text("WIN")
                }
              }
            } else if(dealer.sum === players[i].sum) {
              playerDraw(i)
              console.log("Draw!")
              for(let x = 0; x < playerSlotHTML.length; x++) {
                if(players[i].clientId === playerSlotHTML[x]) {
                  $(".player-result:eq("+x+")").removeClass("hide-element")
                  $(".player-result:eq("+x+")").addClass("result-draw")
                  $(".player-result:eq("+x+")").text("DRAW")
                }
              }
            } else {
              dealerWin(i)
              for(let x = 0; x < playerSlotHTML.length; x++) {
                if(players[i].clientId === playerSlotHTML[x]) {
                  $(".player-result:eq("+x+")").removeClass("hide-element")
                  $(".player-result:eq("+x+")").addClass("result-lose")
                  $(".player-result:eq("+x+")").text("LOSE")
                }
              }
            }

            // If player busted, make him Bust!
          } else {
            dealerWin(i)
          }
          // If player has blackjack, make him win!
        } else {
          playerWin(i)
        }
        }

      }

      if(response.method === "playerResultNatural") {
        players = response.players;
        playerNaturalIndex = response.playerNaturalIndex;
        $(".player-result:eq("+playerNaturalIndex+")").removeClass("hide-element")
        $(".player-result:eq("+playerNaturalIndex+")").addClass("result-blackjack")
        $(".player-result:eq("+playerNaturalIndex+")").text("BJ")
      }

      if(response.method === "finalCompare") {
        finalCompareGo();
      }


      // This resets styling only every round
      if(response.method === "resetRound") {
        resetGame();
      }



      if(gameOn) {
        if(!$("#bets-container").hasClass("noclick")) $("#bets-container").addClass("noclick");

      }

      // if(!gameOn) {
      //   if($("#bets-container").hasClass("noclick")) $("#bets-container").removeClass("noclick");
      // }
      



      // This updates theClient and players array accordingly
      if (response.method === "connect" || response.method === "create" || response.method === "joinClient" || response.method === "join" || response.method === "leave" || response.method === "playersLength" || response.method === "playerResult" || response.method === "playerResultNatural") {
        return;
      } else {
        updateAllPlayers()
        syncTheGame()
      }

    } // <------ End of ws message listener

    // Keep everything in sync
    function updateAllPlayers() {

      // UPDATE SPECTATORS STATUS (IMPORTANT TO HAVE THIS AVOVE PLAYERS STATUS, ELSE IT WILL OVERRIDE)
      for(let i = 0; i < spectators.length; i++) {
        if(spectators[i].clientId === clientId) {
          theClient = spectators[i]
        }
      }

      // UPDATE PLAYERS STATUS
      for(let i = 0; i < players.length; i++) {
        if(players[i].clientId === clientId) {
          theClient = players[i]
        }
      }

      // UPDATE STYLE ON TABLE
      for(let i = 0; i < playerSlotHTML.length; i++) {
        if(playerSlotHTML[i] === clientId) theClient.clientId = playerSlotHTML[i];
        
        for(let x = 0; x < players.length; x++) {
          if(players[x].clientId === playerSlotHTML[i]) {
            z = playerSlotHTML.indexOf(playerSlotHTML[i])
            if(playerSlot[z].firstElementChild.nextElementSibling.classList.contains("empty-slot")) playerSlot[z].firstElementChild.nextElementSibling.remove();
            playerSlot[z].firstElementChild.nextElementSibling.classList.remove("hide-element")
            playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.classList.remove("hide-element")
            // playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.classList.remove("hide-element")
            if(players[x].nickname === "") players[x].nickname = "Player";
            playerSlot[z].firstElementChild.nextElementSibling.innerText = players[x].nickname
            playerSlot[z].firstElementChild.nextElementSibling.innerHTML += `<span><img class="player-avatar" src="" alt="avatar"></span>`
            playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.innerHTML = players[x].sum
            // playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.innerHTML = players[x].bet
            // Player busts
            if(players[x].sum > 21) {
              $(".player-result:eq("+z+")").removeClass("hide-element")
              $(".player-result:eq("+z+")").addClass("result-lose")
              $(".player-result:eq("+z+")").text("BUST")        
            }
   
          }
        }
      }

      // Update Dealer Sum
      dealerSlot.firstElementChild.nextElementSibling.innerHTML = dealer.sum
      // Update player
      player = players[currentPlayer]
      // Keep user style balance in sync
      if(theClient.blackjack === false) $("#balance").text(theClient.balance);
    }

    // Keep game.(property) in sync with the actual game, so when a new client joins mid game, all "LOGIC" will syn.
    function syncTheGame() {
      const syncGame = {
        "method": "syncGame",
        "gameId": gameId,
        "player": player,
        "players": players,
        "spectators": spectators,
        "dealer": dealer,
        "gameOn": gameOn
        }
      ws.send(JSON.stringify(syncGame));          
    }

    // Player joins a slot on the table
    for(let s = 0; s < playerSlot.length; s++) {
      (function(index){
        playerSlot[s].addEventListener("click", function() {
          console.log(this)
          if(joined === false && this.firstElementChild.nextElementSibling.classList.value === "empty-slot" && gameOn === false) {
            joined = true;
            theSlot = index
            joinTable();
            // Make player text yellow
            $(this).children("div:nth-child(3)").addClass("highlight")
            $("#bets-container").removeClass("noclick")
            $(".empty-slot").addClass("noclick");
          }
        })
      })(s)
    }

    setTimeout(joinByUrl, 200)
    function joinByUrl() {
      // If player has a roomId in his url
      if(window.location.href.length > 22) {

        // Get last 6 values from url
        const str = window.location.href
        roomId = str.substring(str.length - 6)
        gameId = "http://localhost:8081/" + roomId;
      }
    }

    // Before player exits/resets window, terminate him from the room
    window.addEventListener('beforeunload', function() {
      reload = true;
      terminatePlayer();
    });

    // function noClick() {
    //   while(gameOn) {
    //     if(!$("#bets-container").hasClass("noclick")) {
    //       $("#bets-container").addClass("noclick")
    //     }
        
    //   }
    // }


  </script>
</body>
</html>
