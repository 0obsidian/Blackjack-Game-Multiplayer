<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Page</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <button id="play">Play</button>
  <div>
    <button class="betButtons" value="10">$10</button>
    <button class="betButtons" value="50">$50</button>
    <button class="betButtons" value="100">$100</button>
    <button class="betButtons" value="250">$250</button>
    <button class="betButtons" value="500">$500</button>
  </div>
  <button id="ready">Ready</button>
  <div>
    <button class="userAction" id="stand">Stand</button>
    <button class="userAction" id="hit">Hit</button>
    <button class="userAction" id="doubleDown">Double Down</button>
  </div>
  <div>
    <button class="countAce">Count as 1</button>
    <button class="countAce">Count as 11</button>
  </div>
  <div id="players-container">
    <span class="players">
      <div class="player-name">A PLAYER</div>
      <div class="player-sum">sum here</div>
      <div class="player-bet">bet here</div>
      <div class="player-ready">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="player-name">A PLAYER</div>
      <div class="player-sum">sum here</div>
      <div class="player-bet">bet here</div>
      <div class="player-ready">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="player-name">A PLAYER</div>
      <div class="player-sum">sum here</div>
      <div class="player-bet">bet here</div>
      <div class="player-ready">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="player-name">A PLAYER</div>
      <div class="player-sum">sum here</div>
      <div class="player-bet">bet here</div>
      <div class="player-ready">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="player-name">A PLAYER</div>
      <div class="player-sum">sum here</div>
      <div class="player-bet">bet here</div>
      <div class="player-ready">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="player-name">A PLAYER</div>
      <div class="player-sum">sum here</div>
      <div class="player-bet">bet here</div>
      <div class="player-ready">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="player-name">A PLAYER</div>
      <div class="player-sum">sum here</div>
      <div class="player-bet">bet here</div>
      <div class="player-ready">Player ready here</div>
      <div class="player-cards">
      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
  </div>
  <button id="leave-table">Leave Table</button>
  <div id="dealer">
    <h2>Dealer</h2>
    <div id="dealerSum">sum here</div>
    <div class="dealer-cards">

    </div>
  </div>
  <div>
      <button>Go To Table</button>
  </div>

<!-- PRE-LOAD DECK IMAGES -->

<div class="hidden">
	<script>

			var images = new Array()
			function preload() {
				for (i = 0; i < preload.arguments.length; i++) {
					images[i] = new Image()
					images[i].src = preload.arguments[i]
				}
			}
			preload(
        "/imgs/Heart2.svg",
        "/imgs/Heart3.svg",
        "/imgs/Heart4.svg",
        "/imgs/Heart5.svg",
        "/imgs/Heart6.svg",
        "/imgs/Heart7.svg",
        "/imgs/Heart8.svg",
        "/imgs/Heart9.svg",
        "/imgs/Heart10.svg",
        "/imgs/HeartJ.svg",
        "/imgs/HeartQ.svg",
        "/imgs/HeartK.svg",
        "/imgs/HeartA.svg",
        "/imgs/Diamond2.svg",
        "/imgs/Diamond3.svg",
        "/imgs/Diamond4.svg",
        "/imgs/Diamond5.svg",
        "/imgs/Diamond6.svg",
        "/imgs/Diamond7.svg",
        "/imgs/Diamond8.svg",
        "/imgs/Diamond9.svg",
        "/imgs/Diamond10.svg",
        "/imgs/DiamondJ.svg",
        "/imgs/DiamondQ.svg",
        "/imgs/DiamondK.svg",
        "/imgs/DiamondA.svg",
        "/imgs/Spade2.svg",
        "/imgs/Spade3.svg",
        "/imgs/Spade4.svg",
        "/imgs/Spade5.svg",
        "/imgs/Spade6.svg",
        "/imgs/Spade7.svg",
        "/imgs/Spade8.svg",
        "/imgs/Spade9.svg",
        "/imgs/Spade10.svg",
        "/imgs/SpadeJ.svg",
        "/imgs/SpadeQ.svg",
        "/imgs/SpadeK.svg",
        "/imgs/SpadeA.svg",
        "/imgs/Club2.svg",
        "/imgs/Club3.svg",
        "/imgs/Club4.svg",
        "/imgs/Club5.svg",
        "/imgs/Club6.svg",
        "/imgs/Club7.svg",
        "/imgs/Club8.svg",
        "/imgs/Club9.svg",
        "/imgs/Club10.svg",
        "/imgs/ClubJ.svg",
        "/imgs/ClubQ.svg",
        "/imgs/ClubK.svg",
        "/imgs/ClubA.svg"
			)

	</script>
</div>










<!--  -->
  <button id= "btnCreate">New Game</button>
  <button id="btnJoin">Join Game</button>
  <input type="text" id="txtGameId">
  <div id="divPlayers"></div>
  <div id="divBoard"></div>
<!--  -->

  <script type="text/javascript" src="/js/app.js"></script>

  <script>
    // HTML elements
    let clientId = null;
    let gameId = null;
    let roomId = null;
    let theClient = null;
    players = [];
    spectators = [];
    playerSlotHTML = [];

    let clicked = null;
    let doubleDown = null;

    let ws = new WebSocket("ws://localhost:8080")
    const btnCreate = document.getElementById("btnCreate");
    const btnJoin = document.getElementById("btnJoin");
    const txtGameId = document.getElementById("txtGameId");
    const divPlayers = document.getElementById("divPlayers");
    const divBoard = document.getElementById("divBoard");

    // CSS
    let theSlot = null;
    let z = null; // last player table index
    let aPlayer = null;
    let joined = false;
    let playerSlot = document.querySelectorAll(".players")
    let playerCards = document.querySelectorAll(".player-cards")
    let dealerCards = document.querySelectorAll(".dealer-cards")
    let dealerSlot = document.querySelector("#dealer")
    let dealerHiddenCard = null;
    let dealerHiddenCardRemoveNext = false;
    let resetCards = false;
    // let playerBet = document.querySelectorAll(".player-bet")
    // let playerBet = document.querySelectorAll(".player-bet")

    const leaveTable = document.querySelector("#leave-table")
    // CSS

    // wiring events
    btnJoin.addEventListener("click", (e) => {
      // window.history.pushState('page2', 'Title', "http://localhost:8081/" + gameId);
      // location.href = "http://localhost:8081/" + gameId;
      playerJoin();
    });
    function playerJoin() {
      console.log("-----")
      console.log(spectators)

      if (gameId === null) {
        gameId = txtGameId.value;
      }
      const payLoad = {
        "method": "join",
        "clientId": clientId,
        "gameId": gameId,
        "roomId": roomId,
        "theClient": theClient,
        "playerSlot": playerSlot,
        "playerSlotHTML": playerSlotHTML, 
        "players": players,
        "spectators": spectators
      }
      ws.send(JSON.stringify(payLoad));
    }

    btnCreate.addEventListener("click", (e) => {
      const payLoad = {
        "method": "create",
        "clientId": clientId,
        "theClient": theClient,
        "playerSlot": playerSlot,
        "playerSlotHTML": playerSlotHTML,
        "roomId": roomId
      }
      ws.send(JSON.stringify(payLoad));
    });

    function sendPlayerBets() {
      const payLoad = {
        "method": "bet",
        "players": players
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updatePlayerCards() {
      const payLoad = {
        "method": "updatePlayerCards",
        "players": players,
        "player": player,
        "resetCards": resetCards
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateDealerCards() {
      const payLoad = {
        "method": "updateDealerCards",
        "players": players,
        "player": player,
        "dealer": dealer,
        "dealersTurn": dealersTurn,
        "dealerHiddenCardRemoveNext": dealerHiddenCardRemoveNext
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendPlayerDeck() {
      const payLoad = {
        "method": "deck",
        "players": players,
        "deck": deck
      }
      ws.send(JSON.stringify(payLoad));
    }

    function clientIsReady() {
      theClient.isReady = true;

      const payLoad = {
        "method": "isReady",
        "players": players,
        "theClient": theClient
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updatePlayers() {
      const payLoad = {
        "method": "update",
        "players": players,
        "dealer": dealer,
        "deck": deck
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateCurrentPlayer() {
      const payLoad = {
        "method": "currentPlayer",
        "players": players,
        "player": player,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendPlayerThePlay() {
      const payLoad = {
        "method": "thePlay",
        "players": players,
        "player": player,
        "currentPlayer": currentPlayer,
        "theClient": theClient,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function joinTable() {
      const payLoad = {
        "method": "joinTable",
        "players": players,
        "theClient": theClient,
        "theSlot": theSlot,
        "playerSlotHTML": playerSlotHTML,
        "gameId": gameId
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateTable() {
      const payLoad = {
        "method": "updateTable",
        "players": players,
        "theClient": theClient,
        "theSlot": theSlot,
        "playerSlot": playerSlot,
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendDealersTurn() {
      const payLoad = {
        "method": "dealersTurn",
        "players": players,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    // function resetCards() {
    //   const payLoad = {
    //     "method": "resetCards",
    //     "players": players,
    //     "playerCards": playerCards,
    //     "dealerCards": dealerCards
    //   }
    //   ws.send(JSON.stringify(payLoad));
    // }
    function terminatePlayer() {
      const payLoad = {
        "method": "terminate",
        "spectators": spectators,
        "theClient": theClient,
        "gameId": gameId,
        "playerSlotHTML": playerSlotHTML,
        "players": players
      }
      ws.send(JSON.stringify(payLoad));
    }



    ws.onmessage = message => {
      // message.data
      const response = JSON.parse(message.data)
      console.log(response);
      // connect
      if (response.method === "connect") {
        clientId = response.clientId;
        theClient = response.theClient;
        console.log("Client id Set successfully " + clientId);

      }

      if (response.method === "leave") {
        // theClient = response.theClient;
        spectators = response.spectators;
        playerSlotIndex = response.playerSlotIndex;

        setTimeout(testt, 1000)
        function testt() {
        playerSlot[playerSlotIndex].innerHTML = 
        `
        <div class="player-name">A PLAYER</div>
        <div class="player-sum">sum here</div>
        <div class="player-bet">bet here</div>
        <div class="player-ready">Player ready here</div>
        <div class="player-cards">

        </div>
        `
        }

      }

      // create
      if (response.method === "create") {
        gameId = response.game.id;
        roomId = response.roomId;
        console.log(roomId)
        console.log(gameId)
        console.log("Game successfully created with id " + response.game.id);
      }

      // join
      if (response.method === "join") {
        game = response.game;
        players = response.players
        spectators = response.spectators
        playerSlotHTML = response.playerSlotHTML
        roomId = response.roomId;

        roomId = gameId.substring(gameId.length - 6)
        window.history.pushState('game', 'Title', '/' + roomId);
        // window.history.pushState('page2', 'Title', "/" + roomId);
      }
      // Assigns the "clientId" to "theClient"
      if(response.method === "joinClient") {
        theClient = response.theClient
      }
      // Updated players array (i.e. players[i] = theClient)
      if(response.method === "updateClientArray") {
        players = response.players
        spectators = response.spectators
        playerSlotHTML = response.playerSlotHTML
      }

      // bet
      if (response.method === "bet") {
        players = response.players;
      }
      // deck
      if (response.method === "deck") {
        deck = response.deck;
      }

      if (response.method === "isReady") {
        players = response.players;
      }

      // currentPlayer
      if (response.method === "currentPlayer") {
        player = response.player;
      }

      if(response.method === "updatePlayerCards") {
        resetCards = response.resetCards
        players = response.players
        player = response.player
        // setTimeout(function() {
        console.log("give the player the card :DDDD")
        for(let i = 0; i < playerSlotHTML.length; i++) {
          // for(let x = 0; x < players.length; x++) {

            if(player.clientId === playerSlotHTML[i]) {
              z = playerSlotHTML.indexOf(playerSlotHTML[i])
              // playerSlot[z].lastElementChild.innerHTML += 
              // `
              // <div class="card">
              //   <div class="value"></div>
              //   <div class="suit"></div>
              // </div>
              // `

            // if(player.bet === 0) {
            //   playerSlot[z].lastElementChild.innerHTML = "";
            // } else {
            //   playerSlot[z].lastElementChild.lastElementChild.innerHTML += player.cards.slice(-1)[0].value.card
            // }

            console.log(resetCards)
            for(let c = 0; c < deckImg.length; c++) {
              if(player.cards.slice(-1)[0].suit + player.cards.slice(-1)[0].value.card === deckImg[c]) {
                console.log(playerSlot[z].lastElementChild)
                playerSlot[z].lastElementChild.innerHTML += 
                `<img class="cardImg" src="/imgs/` + deckImg[c] + `.svg">`
              }
            }

            // player.cards.slice(-1)[0].suit + player.cards.slice(-1)[0].value.card

                    


          }        
        }
        if(resetCards === true) {
          for(let s = 0; s < playerSlot.length; s++) {
            playerSlot[s].lastElementChild.innerHTML = ""
          }
          dealerSlot.lastElementChild.innerHTML = "";
          resetCards = false;
        }

      }

      if (response.method === "updateDealerCards") {
        dealerHiddenCardRemoveNext = response.dealerHiddenCardRemoveNext
        dealersTurn = response.dealersTurn
        if(dealersTurn === false) {
          dealer = response.dealer
        } else {
          player = response.player
          dealer = player
        }

        console.log(dealer.cards.length)
        console.log(dealerHiddenCardRemoveNext)
        if(dealer.cards.length === 2 && dealerHiddenCardRemoveNext === true) {
          dealerHiddenCard.remove()
          dealerHiddenCardRemoveNext = false;
        }
        if(dealer.hiddenCard.length === 0 || undefined) {
          // dealerSlot.lastElementChild.innerHTML += 
          // `
          // <div class="card">
          //   <div class="value"></div>
          //   <div class="suit"></div>
          // </div>
          // `
          for(let c = 0; c < deckImg.length; c++) {
          if(dealer.cards.slice(-1)[0].suit + dealer.cards.slice(-1)[0].value.card === deckImg[c]) {
            dealerSlot.lastElementChild.innerHTML += 
            `<img class="cardImg" src="/imgs/` + deckImg[c] + `.svg">`
          }
        }
        } else {
          dealerSlot.lastElementChild.innerHTML += 
          `
          <div class="hiddenCard">
            <div class="value"></div>
            <div class="suit"></div>
          </div>
          `;

          dealerHiddenCard = document.querySelector(".hiddenCard")
          dealerHiddenCardRemoveNext = true;
        }

        if(dealer.hiddenCard.length === 1 && dealerHiddenCardRemoveNext === true) {
          dealerSlot.lastElementChild.lastElementChild.innerHTML += dealer.hiddenCard.slice(-1)[0].value.card
        } else {
          dealerSlot.lastElementChild.lastElementChild.innerHTML += dealer.cards.slice(-1)[0].value.card
        }

        // if(resetCards === true) {
        //   dealerSlot.lastElementChild.innerHTML = "";
        // }
      }



      // update
      if (response.method === "update") {
        players = response.players;
        dealer = response.dealer;
        deck = response.deck;
        
      }

      // the playe
      if (response.method === "thePlay") {
        player = response.player
        currentPlayer = response.currentPlayer
        if(dealersTurn) {
          return;
        } else {
          if(player.clientId === theClient.clientId && player.bet > 0) {
            clicked = false;
            console.log("SAY THAT ITS YOUR TURN")
            thePlay()
          } else if(player.clientId === theClient.clientId && player.bet === 0) {
            console.log("you blackjacked or busted")
            sendPlayerNext()
          } else {
            clicked = true;          
            console.log("WAIT FOR YOUR TURN")    
          }          
        }

        
      }

      // Join Table
      if(response.method === "joinTable") {
        game = response.game;
        spectators = response.spectators
        players = response.players
        theSlot = response.theSlot
        user = response.user
        // playerSlot[theSlot].innerHTML = user.clientId
        playerSlotHTML = response.playerSlotHTML
        // playerSlot[theSlot].innerHTML = playerSlotHTML



      }

      if(response.method === "dealersTurn") {
        dealersTurn = response.dealersTurn
      }

      // if(response.method === "resetCards") {
      //   console.log("resetCards")
      //   playerCards = response.playerCards
      //   dealerCards = response.dealerCards

      //   console.log(playerCards)
      //   console.log(dealerCards)
      //   for(let c = 0; c < playerCards.length; c++) {
      //     playerCards[c].innerHTML = "";
      //   }
      //   for(let d = 0; d < dealerCards.length; d++) {
      //     dealerCards[d].innerHTML = "";
      //   }
      // }



      
      // if(spectators.length > 0) updateAllPlayers();

      // This updates theClient and players array accordingly
      if (response.method === "connect" || response.method === "create" || response.method === "join" || response.method === "joinClient") {
        return;
      } else {
        updateAllPlayers()
      }

    }
    // MUST INCLUDE THIS IN EVERY RESPONSE AFTER ALL PLAYERS HAVE JOINED, TO KEEP "theClient" and players[i] UPDATED
    function updateAllPlayers() {

      // UPDATE SPECTATORS STATUS (IMPORTANT TO HAVE THIS AVOVE PLAYERS STATUS, ELSE IT WILL OVERRIDE)
      for(let i = 0; i < spectators.length; i++) {
        if(spectators[i].clientId === clientId) {
          theClient = spectators[i]
        }
      }

      // UPDATE PLAYERS STATUS
      for(let i = 0; i < players.length; i++) {
        if(players[i].clientId === clientId) {
          theClient = players[i]
        }
      }

      // if(spectators.length > 0) {
      for(let i = 0; i < playerSlotHTML.length; i++) {
        if(playerSlotHTML[i] === clientId) theClient.clientId = playerSlotHTML[i];
        
        for(let x = 0; x < players.length; x++) {

          if(players[x].clientId === playerSlotHTML[i]) {
            z = playerSlotHTML.indexOf(playerSlotHTML[i])
            playerSlot[z].firstElementChild.innerHTML = players[x].clientId
            playerSlot[z].firstElementChild.nextElementSibling.innerHTML = players[x].sum
            playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.innerHTML = players[x].bet
            if(players[x].isReady === true) {
              playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.innerText = "READY"
            } else {
              playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.innerText = "NOT READY"
            }
            
            // playerSlot[z].lastElementChild.innerHTML += 
            // `
            // <div class="card">
            // <div class="value"></div>
            // <div class="suit"></div>
            // </div>
            // `
            // for(let c = 0; c < players[x].cards.length; c++) {
            //   playerSlot[z].lastElementChild.firstElementChild.innerHTML += players[x].cards[c].value.card
            // }
            
            
          }

        }

        
      }

      // Update Dealer Sum
      dealerSlot.firstElementChild.nextElementSibling.innerHTML = dealer.sum

      player = players[currentPlayer]

      


    }
    






      // *******UPDATE CSS*******
        // for(let i = 0; i < players.length; i++) {
          for(let s = 0; s < playerSlot.length; s++) {
            (function(index){
              playerSlot[s].addEventListener("click", function() {
                if(joined === false && this.firstElementChild.innerHTML === "A PLAYER") {
                  joined = true;
                  theSlot = index
                  // playerSlot[theSlot].innerHTML = theClient.clientId
                  joinTable();
                }
              })
            })(s)
          }


        // }
      // *******UPDATE CSS*******

      setTimeout(joinByUrl, 200)
      function joinByUrl() {
        // If player has a roomId in his url
        if(window.location.href.length > 22) {
          // Get last 6 values from url
          const str = window.location.href
          roomId = str.substring(str.length - 6)
          console.log(roomId)
          // make gameId same as Url
          // go to line ~413 for more info on roomId
          gameId = "http://localhost:8081/" + roomId;
          playerJoin()
        }
      }




    window.addEventListener('beforeunload', function() {
      // ws.close();
      terminatePlayer();
      // ws.close();
    });




  </script>
</body>
</html>
