<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Page</title>
  <!-- <link rel="stylesheet" href="/css/lib/normalize.css"> -->
  <link rel="stylesheet" href="/css/dist/style.css">
  <link rel="stylesheet" href="/css/style.scss">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div id="info-rules">
    <div id="how-to-play">
      HOW TO PLAY
    </div>
    <div id="info-rules-overflow">
    <div>
      <h1 id="h1margin">OBJECT OF THE GAME</h1>
      <P>
        Each participant attempts to beat the dealer by getting a count as close to 21 as possible, without going above 21.
      </P>
    </div>
    <div>
      <h1>CARD VALUES/SCORING</h1>
      <p>
        Usually it's up to each individual player if an ace is worth 1 or 11. However in this game if a player stands with an ace, it will always count the ace as 11 if your total sum doesn't exceed 21. Face cards are 10 and any other card is its original value.</p>
    </div>
    <div>
      <h1>BETTING</h1>
      <p>
        Before the dealer begins dealing out cards, each player must place a bet and hit ready.</p>
    </div>
    <div>
      <h1>THE DEAL</h1>
      <p>
        The round starts with the dealer giving out 2 cards to each player. He also gives himself one card facing up & one card facing down.</p>
    </div>
    <div>
      <h1>NATURALS</h1>
      <p>
        When the intial 2 cards has been dealt: If a player gets a count to 21 on the first 2 cards, the player gets whats called Blackjack. Blakjack pays out 3:2 directly to the player and he will wait until next round to play again.</p>
    </div>
    <div>
      <h1>THE PLAY</h1>
      <p>
        Now its time for the first player to make his move.
        The player can Hit, Stand, Or Double Down.
        <ul>
          <li><strong>Hit</strong> = ask for another card in attempt to get closer to 21.</li>
          <li><strong>Stand</strong> = Don't ask for any cards, moves on to the next player</li>
          <li><strong>Double Down</strong> = Double the bet and ask for another card. (Can only double down once per round & can't draw any more cards after double'd down).</li>
        </ul>
      </p>
    </div>
    <div>
      <h1>THE DEALER'S PLAY</h1>
      <p>
        Dealer starts with taking his card facing down. Dealer will draw until he reaches 17, when dealer's sum is 17 or above, he stops taking cards.
      </p>
    </div>
    <div>
      <h1>PAYOUT</h1>
      <p>
        <ul>
          <li>If the player busts, he will lose his bet, even if the dealer also busts.</li>
          <li>If player has higher value cards than the dealer, the player wins.</li>
          <li>If dealer has higher value cards than the player, the dealer wins.</li>
        </ul>
      </p>
    </div>
  </div>
  </div>

  <div id="main-menu">
    <img id="blackjack-title" src="/imgs/blackjack21io.png" alt="blackjack21.io">
    <div id="main-box">
      <div id="avatar-box">
        <i class="fas fa-chevron-left"></i>
        <img src="/imgs/avatars/zimmster.png" alt="avatar" width="80">
        <i class="fas fa-chevron-right"></i>
      </div>
      <div>
        <input id="nickname" type="text" placeholder="Nickname">
      </div>
      <div>
        <button id="btnOffline" class="play-btns "><span><i class="fas fa-user"></i></span>Play Offline</button>
      </div>
      <div>
        <button id="btnCreate" class="play-btns "><span><i class="fas fa-users"></i></span>Create Room</button>
      </div>
      <div>
        <button id="btnJoin" class="play-btns hide-element"><span><i class="fas fa-users"></i></span>Join Room</button>
      </div>
    </div>
    <div id="about-box">
      <strong>blackjack21.io</strong> is a free multiplayer casino game.
      <ul>
        <strong>NOTE:</strong>
        <li>Every game uses ONE standard 52-card pack that shuffles every round.</li>
        <li>Current version of the game does not support Splitting Cards & Insurance.</li>
        <li>2 aces on the first two cards gives you blackjack (21).</li>
        <li>A private room can consist up to 7 players.</li>
      </ul>
      <button id="about">
        About
      </button>
    </div>
  </div>

  <div id="game-room" class="hide-element">
  <button id="play">Play</button>
  <div>
    <button class="betButtons" value="10">$10</button>
    <button class="betButtons" value="50">$50</button>
    <button class="betButtons" value="100">$100</button>
    <button class="betButtons" value="250">$250</button>
    <button class="betButtons" value="500">$500</button>
  </div>
  <button id="ready">Ready</button>
  <div>
    <button class="userAction" id="stand">Stand</button>
    <button class="userAction" id="hit">Hit</button>
    <button class="userAction" id="doubleDown">Double Down</button>
  </div>
  <div>
    <button class="countAce">Count as 1</button>
    <button class="countAce">Count as 11</button>
  </div>
  <div id="players-container">
    <span class="players">
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">A PLAYER</div>
      <div class="player-sum hide-element">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-ready hide-element">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">A PLAYER</div>
      <div class="player-sum hide-element">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-ready hide-element">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">A PLAYER</div>
      <div class="player-sum hide-element">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-ready hide-element">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">plexer</div>
      <div class="player-sum hide-element"></div>
      <div class="player-bet hide-element">1k</div>
      <div class="player-ready hide-element">NOT READY</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">A PLAYER</div>
      <div class="player-sum hide-element">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-ready hide-element">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element highlight">A PLAYER</div>
      <div class="player-sum hide-element">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-ready hide-element">Player ready here</div>
      <div class="player-cards">

      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
    <span class="players">
      <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
      <div class="player-name hide-element">A PLAYER</div>
      <div class="player-sum hide-element">sum here</div>
      <div class="player-bet hide-element">bet here</div>
      <div class="player-ready hide-element">Player ready here</div>
      <div class="player-cards">
      </div>
      <!-- <div class="win-lose-draw">WinLoseOrDraw</div> -->
    </span>
  </div>
  <button id="leave-table">Leave Table</button>
  <div id="dealer">
    <h2>Dealer</h2>
    <div id="dealerSum">sum here</div>
    <div class="dealer-cards">
      <div class="visibleCards">

      </div>
      <!-- <div class="hiddenCard">
        <div class="value"></div>
        <div class="suit"></div>
      </div> -->
    </div>
  </div>
  <div>
      <button>Go To Table</button>
  </div>


</div>

<!-- PRE-LOAD DECK IMAGES -->
<div class="hidden">
	<script>
			var images = new Array()
			function preload() {
				for (i = 0; i < preload.arguments.length; i++) {
					images[i] = new Image()
					images[i].src = preload.arguments[i]
				}
			}
			preload(
        "/imgs/Heart2.svg",
        "/imgs/Heart3.svg",
        "/imgs/Heart4.svg",
        "/imgs/Heart5.svg",
        "/imgs/Heart6.svg",
        "/imgs/Heart7.svg",
        "/imgs/Heart8.svg",
        "/imgs/Heart9.svg",
        "/imgs/Heart10.svg",
        "/imgs/HeartJ.svg",
        "/imgs/HeartQ.svg",
        "/imgs/HeartK.svg",
        "/imgs/HeartA.svg",
        "/imgs/Diamond2.svg",
        "/imgs/Diamond3.svg",
        "/imgs/Diamond4.svg",
        "/imgs/Diamond5.svg",
        "/imgs/Diamond6.svg",
        "/imgs/Diamond7.svg",
        "/imgs/Diamond8.svg",
        "/imgs/Diamond9.svg",
        "/imgs/Diamond10.svg",
        "/imgs/DiamondJ.svg",
        "/imgs/DiamondQ.svg",
        "/imgs/DiamondK.svg",
        "/imgs/DiamondA.svg",
        "/imgs/Spade2.svg",
        "/imgs/Spade3.svg",
        "/imgs/Spade4.svg",
        "/imgs/Spade5.svg",
        "/imgs/Spade6.svg",
        "/imgs/Spade7.svg",
        "/imgs/Spade8.svg",
        "/imgs/Spade9.svg",
        "/imgs/Spade10.svg",
        "/imgs/SpadeJ.svg",
        "/imgs/SpadeQ.svg",
        "/imgs/SpadeK.svg",
        "/imgs/SpadeA.svg",
        "/imgs/Club2.svg",
        "/imgs/Club3.svg",
        "/imgs/Club4.svg",
        "/imgs/Club5.svg",
        "/imgs/Club6.svg",
        "/imgs/Club7.svg",
        "/imgs/Club8.svg",
        "/imgs/Club9.svg",
        "/imgs/Club10.svg",
        "/imgs/ClubJ.svg",
        "/imgs/ClubQ.svg",
        "/imgs/ClubK.svg",
        "/imgs/ClubA.svg"
			)
	</script>
</div>






  <script type="text/javascript" src="js/lib/jquery-3.5.1.min.js"></script>
  <script type="text/javascript" src="/js/app.js"></script>

  <script>
    // HTML elements
    let clientId = null;
    let gameId = null;
    let roomId = null;
    let theClient = null;
    players = [];
    spectators = [];
    playerSlotHTML = [];

    let clicked = null;
    let doubleDown = null;
    let reload = null;

    let ws = new WebSocket("ws://localhost:8080")
    const btnCreate = document.getElementById("btnCreate");
    const btnJoin = document.getElementById("btnJoin");
    const txtGameId = document.getElementById("txtGameId");
    const divPlayers = document.getElementById("divPlayers");
    const divBoard = document.getElementById("divBoard");

    // CSS
    let nickname = document.querySelector("#nickname");
    let playersLength = null;
    let theSlot = null;
    let z = null; // last player table index
    let aPlayer = null;
    let joined = false;
    let playerSlot = document.querySelectorAll(".players")
    let playerCards = document.querySelectorAll(".player-cards")
    let dealerCards = document.querySelectorAll(".dealer-cards")
    let dealerSlot = document.querySelector("#dealer")
    let playerName = document.querySelectorAll(".player-name")
    let dealerHiddenCard = null;
    let dealerHiddenCardRemoveNext = false;
    let resetCards = false;
    // let playerBet = document.querySelectorAll(".player-bet")
    // let playerBet = document.querySelectorAll(".player-bet")

    const leaveTable = document.querySelector("#leave-table")
    // CSS

    // wiring events
    btnJoin.addEventListener("click", (e) => {
      const payLoadLength = {
        "method": "playersLength",
        "gameId": gameId
      }
      ws.send(JSON.stringify(payLoadLength));

      setTimeout(function() {
        if(playersLength >= 7) {
        alert("Game Is full!")
        return;
      } else {
        playerJoin()
        setTimeout(function() {
          $("#main-menu").addClass("hide-element")
          $("#game-room").removeClass("hide-element")
          }, 500)        
        }
      }, 50)
    });
    function playerJoin() {
      console.log("##################")
      nickname = nickname.value
      console.log(nickname)
      theClient.nickname = nickname.value
      console.log("##################")
      if (gameId === null) {
        gameId = txtGameId.value;
      }
      const payLoad = {
        "method": "join",
        "clientId": clientId,
        "gameId": gameId,
        "roomId": roomId,
        "theClient": theClient,
        "playerSlot": playerSlot,
        "playerSlotHTML": playerSlotHTML, 
        "players": players,
        "spectators": spectators,
        "nickname": nickname
      }
      ws.send(JSON.stringify(payLoad));
    }

    btnCreate.addEventListener("click", (e) => {
      const payLoad = {
        "method": "create",
        "clientId": clientId,
        "theClient": theClient,
        "playerSlot": playerSlot,
        "playerSlotHTML": playerSlotHTML,
        "roomId": roomId
      }
      ws.send(JSON.stringify(payLoad));

      // setTimeout(playerJoin, 500)
      setTimeout(function() {
      playerJoin()
      $("#main-menu").addClass("hide-element")
      $("#game-room").removeClass("hide-element")
      }, 500)
    });

    leaveTable.addEventListener("click", (e) => {
      joined = false;
      terminatePlayer();
    });

    function sendPlayerBets() {
      const payLoad = {
        "method": "bet",
        "players": players,
        "spectators": spectators
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updatePlayerCards() {
      const payLoad = {
        "method": "updatePlayerCards",
        "players": players,
        "spectators": spectators,
        "player": player,
        "resetCards": resetCards
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateDealerCards() {
      const payLoad = {
        "method": "updateDealerCards",
        "players": players,
        "spectators": spectators,
        "player": player,
        "dealer": dealer,
        "dealersTurn": dealersTurn,
        "dealerHiddenCardRemoveNext": dealerHiddenCardRemoveNext
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendPlayerDeck() {
      const payLoad = {
        "method": "deck",
        "players": players,
        "spectators": spectators,
        "deck": deck,
        "gameOn": gameOn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function clientIsReady() {
      theClient.isReady = true;

      const payLoad = {
        "method": "isReady",
        "players": players,
        "spectators": spectators,
        "theClient": theClient
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updatePlayers() {
      const payLoad = {
        "method": "update",
        "players": players,
        "spectators": spectators,
        "dealer": dealer,
        "deck": deck,
        "gameOn": gameOn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateCurrentPlayer() {
      const payLoad = {
        "method": "currentPlayer",
        "players": players,
        "spectators": spectators,
        "player": player,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendPlayerThePlay() {
      const payLoad = {
        "method": "thePlay",
        "players": players,
        "spectators": spectators,
        "player": player,
        "currentPlayer": currentPlayer,
        "theClient": theClient,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    function joinTable() {
      const payLoad = {
        "method": "joinTable",
        "players": players,
        "spectators": spectators,
        "theClient": theClient,
        "theSlot": theSlot,
        "playerSlotHTML": playerSlotHTML,
        "gameId": gameId
      }
      ws.send(JSON.stringify(payLoad));
    }

    function updateTable() {
      const payLoad = {
        "method": "updateTable",
        "players": players,
        "spectators": spectators,
        "theClient": theClient,
        "theSlot": theSlot,
        "playerSlot": playerSlot,
      }
      ws.send(JSON.stringify(payLoad));
    }

    function sendDealersTurn() {
      const payLoad = {
        "method": "dealersTurn",
        "players": players,
        "spectators": spectators,
        "dealersTurn": dealersTurn
      }
      ws.send(JSON.stringify(payLoad));
    }

    // function resetCards() {
    //   const payLoad = {
    //     "method": "resetCards",
    //     "players": players,
    //     "playerCards": playerCards,
    //     "dealerCards": dealerCards
    //   }
    //   ws.send(JSON.stringify(payLoad));
    // }
    function terminatePlayer() {
      console.log("terminate")
      console.log(reload)
      const payLoad = {
        "method": "terminate",
        "spectators": spectators,
        "theClient": theClient,
        "gameId": gameId,
        "playerSlotHTML": playerSlotHTML,
        // "players": players,
        "reload": reload
      }
      ws.send(JSON.stringify(payLoad));
    }



    ws.onmessage = message => {
      // message.data
      const response = JSON.parse(message.data)
      console.log(response);
      // connect
      if (response.method === "connect") {
        clientId = response.clientId;
        theClient = response.theClient;
        console.log("Client id Set successfully " + clientId);

      }

      if (response.method === "leave") {
        console.log("leave")
        console.log(game.players)
        // theClient = response.theClient;
        // spectators = response.spectators;
        game = response.game
        players = game.players
        spectators = game.spectators
        playerSlotHTML = game.playerSlotHTML
        console.log(spectators)
        console.log(players)
        // players = response.players;
        // playerSlotHTML = response.playerSlotHTML
        playerSlotIndex = response.playerSlotIndex;
        reload = false;

        if(playerSlotIndex === undefined) {
          return;
        } else {
          playerSlot[playerSlotIndex].innerHTML = 
          `
          <div class="empty-slot"><i class="fas fa-user-plus"></i></div>
          <div class="player-name hide-element">A PLAYER</div>
          <div class="player-sum hide-element">sum here</div>
          <div class="player-bet hide-element">bet here</div>
          <div class="player-ready hide-element">Player ready here</div>
          <div class="player-cards">

          </div>
          `
        }


      }

      // create
      if (response.method === "create") {
        gameId = response.game.id;
        roomId = response.roomId;
        console.log(roomId)
        console.log(gameId)
        console.log("Game successfully created with id " + response.game.id);
      }

      // join
      if (response.method === "join") {
        game = response.game;
        // players = response.players
        spectators = response.spectators
        playerSlotHTML = response.playerSlotHTML
        roomId = response.roomId;

        roomId = gameId.substring(gameId.length - 6)
        window.history.pushState('game', 'Title', '/' + roomId);
        // window.history.pushState('page2', 'Title', "/" + roomId);
      }
      // Assigns the "clientId" to "theClient"
      if(response.method === "joinClient") {
        console.log("ASDASDASDASASDASDASDADS")
        // $("#main-menu").addClass("hide-element")
        // $("#game-room").removeClass("hide-element")
        theClient = response.theClient
        game = response.game
        // gameOn = game.gameOn

        // If client joins mid game
        if(game.gameOn === true) {
          gameOn = game.gameOn
          dealer = game.dealer
          player = game.player
          if(dealer.hiddenCard.length > 0) {
            dealerSlot.lastElementChild.innerHTML += 
          `
          <div class="hiddenCard">
            <div class="value"></div>
            <div class="suit"></div>
          </div>
          `;

          dealerHiddenCard = document.querySelector(".hiddenCard")
          dealerHiddenCardRemoveNext = true;
          }

          // UPDATE HTML CARDS OF PLAYERS
          // Find all players and its cards and compare it to the deckImg
          for(let i = 0; i < players.length; i++) {
            for(let d = 0; d < deckImg.length; d++) {
              for(let c = 0; c < players[i].cards.length; c++) {
                if(players[i].cards[c].suit + players[i].cards[c].value.card === deckImg[d]) {

                  // Now apply the cards to the right table slot.
                  for(let s = 0; s < playerSlotHTML.length; s++) {
                    if(players[i].clientId === playerSlotHTML[s]) {
                      playerSlot[s].lastElementChild.innerHTML += 
                      `<img class="cardImg" src="/imgs/` + deckImg[d] + `.svg">`
                    }
                  }
                }
              }       
            }
          }

          // UPDATE HTML CARDS OF DEALER
          for(let d = 0; d < deckImg.length; d++) {
            for(let c = 0; c < dealer.cards.length; c++) {
              if(dealer.cards[c].suit + dealer.cards[c].value.card === deckImg[d]) {
                dealerSlot.lastElementChild.firstElementChild.innerHTML += 
                `<img class="cardImg" src="/imgs/` + deckImg[d] + `.svg">`
              }
            }

              // if(dealer.hiddenCard[0].suit + dealer.hiddenCard[0].value.card === deckImg[d]) {
              //   dealerSlot.lastElementChild.firstElementChild.innerHTML += 
              //   `<img class="cardImg" src="/imgs/` + deckImg[d] + `.svg">`
              // }

            }

          }
        }



      // Updated players array (i.e. players[i] = theClient)
      if(response.method === "updateClientArray") {
        players = response.players
        spectators = response.spectators
        playerSlotHTML = response.playerSlotHTML
      }

      // bet
      if (response.method === "bet") {
        players = response.players;
        // spectators = response.spectators
      }
      // deck
      if (response.method === "deck") {
        deck = response.deck;
        gameOn = response.gameOn
      }

      if (response.method === "isReady") {
        players = response.players;
      }

      // currentPlayer
      if (response.method === "currentPlayer") {
        player = response.player;
      }

      if(response.method === "updatePlayerCards") {
        resetCards = response.resetCards
        players = response.players
        player = response.player
        // setTimeout(function() {
        console.log("give the player the card :DDDD")
        for(let i = 0; i < playerSlotHTML.length; i++) {
          // for(let x = 0; x < players.length; x++) {

            if(player.clientId === playerSlotHTML[i]) {
              z = playerSlotHTML.indexOf(playerSlotHTML[i])
              // playerSlot[z].lastElementChild.innerHTML += 
              // `
              // <div class="card">
              //   <div class="value"></div>
              //   <div class="suit"></div>
              // </div>
              // `

            // if(player.bet === 0) {
            //   playerSlot[z].lastElementChild.innerHTML = "";
            // } else {
            //   playerSlot[z].lastElementChild.lastElementChild.innerHTML += player.cards.slice(-1)[0].value.card
            // }

            console.log(resetCards)
            for(let c = 0; c < deckImg.length; c++) {
              if(player.cards.slice(-1)[0].suit + player.cards.slice(-1)[0].value.card === deckImg[c]) {
                console.log(playerSlot[z].lastElementChild)
                playerSlot[z].lastElementChild.innerHTML += 
                `<img class="cardImg" src="/imgs/` + deckImg[c] + `.svg">`
              }
            }

            // player.cards.slice(-1)[0].suit + player.cards.slice(-1)[0].value.card

                    


          }        
        }
        if(resetCards === true) {
          for(let s = 0; s < playerSlot.length; s++) {
            playerSlot[s].lastElementChild.innerHTML = ""
          }
          dealerSlot.lastElementChild.lastElementChild.innerHTML = "";
          resetCards = false;
        }

      }

      if (response.method === "updateDealerCards") {
        dealerHiddenCardRemoveNext = response.dealerHiddenCardRemoveNext
        dealersTurn = response.dealersTurn
        if(dealersTurn === false) {
          dealer = response.dealer
        } else {
          player = response.player
          dealer = player
        }

        console.log(dealer.cards.length)
        console.log(dealerHiddenCardRemoveNext)
        if(dealer.cards.length === 2 && dealerHiddenCardRemoveNext === true) {
          dealerHiddenCard.remove()
          dealerHiddenCardRemoveNext = false;
        }
        if(dealer.hiddenCard.length === 0 || undefined) {
          // dealerSlot.lastElementChild.innerHTML += 
          // `
          // <div class="card">
          //   <div class="value"></div>
          //   <div class="suit"></div>
          // </div>
          // `
          for(let c = 0; c < deckImg.length; c++) {
          if(dealer.cards.slice(-1)[0].suit + dealer.cards.slice(-1)[0].value.card === deckImg[c]) {
            dealerSlot.lastElementChild.firstElementChild.innerHTML += 
            `<img class="cardImg" src="/imgs/` + deckImg[c] + `.svg">`
          }
        }
        } else {
          dealerSlot.lastElementChild.innerHTML += 
          `
          <div class="hiddenCard">
            <div class="value"></div>
            <div class="suit"></div>
          </div>
          `;

          dealerHiddenCard = document.querySelector(".hiddenCard")
          dealerHiddenCardRemoveNext = true;
        }

        // if(dealer.hiddenCard.length === 1 && dealerHiddenCardRemoveNext === true) {
        //   dealerSlot.lastElementChild.lastElementChild.innerHTML += dealer.hiddenCard.slice(-1)[0].value.card
        // } else {
        //   dealerSlot.lastElementChild.lastElementChild.innerHTML += dealer.cards.slice(-1)[0].value.card
        // }

        // if(resetCards === true) {
        //   dealerSlot.lastElementChild.innerHTML = "";
        // }
      }



      // update
      if (response.method === "update") {
        players = response.players;
        dealer = response.dealer;
        deck = response.deck;
        gameOn = response.gameOn;
        
      }

      // the playe
      if (response.method === "thePlay") {
        player = response.player
        currentPlayer = response.currentPlayer
        if(dealersTurn) {
          return;
        } else {
          if(player.clientId === theClient.clientId && player.bet > 0) {
            clicked = false;
            console.log("SAY THAT ITS YOUR TURN")
            thePlay()
          } else if(player.clientId === theClient.clientId && player.bet === 0) {
            console.log("you blackjacked or busted")
            sendPlayerNext()
          } else {
            clicked = true;          
            console.log("WAIT FOR YOUR TURN")    
          }          
        }

        
      }

      // Join Table
      if(response.method === "joinTable") {
        game = response.game;
        spectators = response.spectators
        players = response.players
        theSlot = response.theSlot
        user = response.user
        theClient = response.theClient
        // playerSlot[theSlot].innerHTML = user.clientId
        playerSlotHTML = response.playerSlotHTML
        console.log(theClient.nickname)
        // playerSlot[theSlot].innerHTML = playerSlotHTML
        // playerSlot[theSlot].firstElementChild.remove()
        // playerSlot[theSlot].firstElementChild.classList.remove("hide-element")
        // playerSlot[theSlot].firstElementChild.nextElementSibling.classList.remove("hide-element")
        // playerSlot[theSlot].firstElementChild.nextElementSibling.nextElementSibling.classList.remove("hide-element")
        // playerSlot[theSlot].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.classList.remove("hide-element")



      }

      if(response.method === "dealersTurn") {
        dealersTurn = response.dealersTurn
      }

      if(response.method === "playersLength") {
            playersLength = response.playersLength
            console.log("it WORKRKRRSRS")
          }

      // if(response.method === "resetCards") {
      //   console.log("resetCards")
      //   playerCards = response.playerCards
      //   dealerCards = response.dealerCards

      //   console.log(playerCards)
      //   console.log(dealerCards)
      //   for(let c = 0; c < playerCards.length; c++) {
      //     playerCards[c].innerHTML = "";
      //   }
      //   for(let d = 0; d < dealerCards.length; d++) {
      //     dealerCards[d].innerHTML = "";
      //   }
      // }



      
      // if(spectators.length > 0) updateAllPlayers();

      // This updates theClient and players array accordingly
      if (response.method === "connect" || response.method === "create" || response.method === "joinClient" || response.method === "join" || response.method === "leave") {
        return;
      } else {
        updateAllPlayers()
      }
      if (response.method === "playersLength") {
        return;
      } else {
        syncTheGame()
      }

    }
    // MUST INCLUDE THIS IN EVERY RESPONSE AFTER ALL PLAYERS HAVE JOINED, TO KEEP "theClient" and players[i] UPDATED
    function updateAllPlayers() {

      // UPDATE SPECTATORS STATUS (IMPORTANT TO HAVE THIS AVOVE PLAYERS STATUS, ELSE IT WILL OVERRIDE)
      for(let i = 0; i < spectators.length; i++) {
        if(spectators[i].clientId === clientId) {
          theClient = spectators[i]
        }
      }

      // UPDATE PLAYERS STATUS
      for(let i = 0; i < players.length; i++) {
        if(players[i].clientId === clientId) {
          theClient = players[i]
        }
      }

      for(let i = 0; i < playerSlotHTML.length; i++) {
        if(playerSlotHTML[i] === clientId) theClient.clientId = playerSlotHTML[i];
        
        for(let x = 0; x < players.length; x++) {

          if(players[x].clientId === playerSlotHTML[i]) {
            z = playerSlotHTML.indexOf(playerSlotHTML[i])
            console.log("DADADADADADADADAD")
            if(playerSlot[z].firstElementChild.classList.value === "empty-slot") playerSlot[z].firstElementChild.remove();
            playerSlot[z].firstElementChild.classList.remove("hide-element")
            playerSlot[z].firstElementChild.nextElementSibling.classList.remove("hide-element")
            playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.classList.remove("hide-element")
            playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.classList.remove("hide-element")

            playerSlot[z].firstElementChild.innerHTML = players[x].nickname
            playerSlot[z].firstElementChild.nextElementSibling.innerHTML = players[x].sum
            playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.innerHTML = players[x].bet
            if(players[x].isReady === true) {
              playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.innerText = "READY"
            } else {
              playerSlot[z].firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.innerText = "NOT READY"
            }
          
            
            
          }

        }

      }

      






      // Update Dealer Sum
      dealerSlot.firstElementChild.nextElementSibling.innerHTML = dealer.sum
      player = players[currentPlayer]

      


    }
          // Keep game.(property) in sync with the actual game, so when a new client joins mid game, it will all sync
          function syncTheGame() {
        const syncGame = {
          "method": "syncGame",
          "gameId": gameId,
          "player": player,
          "players": players,
          "spectators": spectators,
          "dealer": dealer,
          "gameOn": gameOn
        }
        ws.send(JSON.stringify(syncGame));          
      }

    






      // *******UPDATE CSS*******
        // for(let i = 0; i < players.length; i++) {
          for(let s = 0; s < playerSlot.length; s++) {
            (function(index){
              playerSlot[s].addEventListener("click", function() {
                console.log(this)
                if(joined === false && this.firstElementChild.classList.value === "empty-slot" && gameOn === false) {
                  joined = true;
                  theSlot = index
                  joinTable();
                  // Make player text yellow
                  $(this).children("div:nth-child(2)").addClass("highlight")
                }
              })
            })(s)
          }


        // }
      // *******UPDATE CSS*******

      setTimeout(joinByUrl, 200)
      function joinByUrl() {
        // If player has a roomId in his url
        if(window.location.href.length > 22) {
          // Get last 6 values from url
          const str = window.location.href
          roomId = str.substring(str.length - 6)
          console.log(roomId)
          // make gameId same as Url
          // go to line ~413 for more info on roomId
          gameId = "http://localhost:8081/" + roomId;

          // playerJoin()
          // $("#main-menu").addClass("hide-element")
          // $("#game-room").removeClass("hide-element")
        }
      }




    window.addEventListener('beforeunload', function() {
      reload = true;
      // ws.close();
      terminatePlayer();
      // ws.close();
    });




  </script>
</body>
</html>
